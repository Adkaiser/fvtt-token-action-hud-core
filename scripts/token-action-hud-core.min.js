const e="token-action-hud-core";class Logger{static info(...e){console.log("Token Action HUD Info |",...e)}static error(...e){console.error("Token Action HUD Error |",...e)}static debug(...e){(game.tokenActionHud?game.tokenActionHud.isDebug:getSetting("debug"))&&console.log("Token Action HUD Debug |",...e)}}function checkAllow(e){return e>=getSetting("allow")}function getSetting(t,i=null){let n=i??null;return game.settings.settings.get(`${e}.${t}`)?n=game.settings.get(e,t):Logger.debug(`Setting '${t}' not found`),n}async function setSetting(t,i){game.settings.settings.get(`${e}.${t}`)?(i=await game.settings.set(e,t,i),Logger.debug(`Setting '${t}' set to '${i}'`)):Logger.debug(`Setting '${t}' not found`)}function switchCSS(e){const t=[{setting:"compact",file:"tah-compact"},{setting:"foundryVTT",file:"tah-foundry-vtt"},{setting:"dorakoUI",file:"tah-dorako"}];for(const i of t){const t=["modules/token-action-hud-core/",`styles/${i.file}`];i.setting===e?Object.values(document.styleSheets).find((e=>e.href?.includes(t[0])&&e.href?.includes(t[1]))).disabled=!1:Object.values(document.styleSheets).find((e=>e.href?.includes(t[0])&&e.href?.includes(t[1]))).disabled=!0}}function registerHandlebars(){Handlebars.registerHelper("cap",(function(e){return!e||e.length<1?"":e[0].toUpperCase()+e.slice(1)}));const reduceOp=function(e,t){(e=Array.from(e)).pop();const i=e.shift();return e.reduce(t,i)};Handlebars.registerHelper({eq:function(){return reduceOp(arguments,((e,t)=>e===t))},ne:function(){return reduceOp(arguments,((e,t)=>e!==t))},lt:function(){return reduceOp(arguments,((e,t)=>e<t))},gt:function(){return reduceOp(arguments,((e,t)=>e>t))},lte:function(){return reduceOp(arguments,((e,t)=>e<=t))},gte:function(){return reduceOp(arguments,((e,t)=>e>=t))},and:function(){return reduceOp(arguments,((e,t)=>e&&t))},or:function(){return reduceOp(arguments,((e,t)=>e||t))}}),Handlebars.registerHelper("activeText",(function(e){return getSetting("activeCssAsText")?e.fn(this):e.inverse(this)}))}function getSubcategories(e){const t=[];for(const i of e)i.subcategories.length>0&&t.push(getSubcategories(i.subcategories).flat()),t.push(i);return t.flat()}function getSubcategoriesById(e,t){if(!e)return;const i=[];for(const n of e)n.subcategories?.length>0&&i.push(getSubcategoriesById(n.subcategories,t).flat()),n.id===t&&i.push(n);return i.flat()}async function getSubcategoryByNestId(e,t){const i=t.split("_"),n=await async function getSubcategoryByParts(e,t){const i=e.find((e=>e.id===t[0]));if(i)return t.length>1?(t.shift(),await getSubcategoryByParts(Object.values(i.subcategories),t)):i;return null}(e,i);return n}const updateFunc=e=>{Logger.debug("Settings updated. Refreshing HUD"),game.tokenActionHud&&game.tokenActionHud.updateSettings()};let t;const registerSettings=function(e,i,n){t=e,game.settings.register(t,"startup",{name:"One-Time Startup Prompt",scope:"world",config:!1,type:Boolean,default:!1}),game.settings.register(t,"rollHandler",{name:game.i18n.localize("tokenActionHud.settings.rollHandler.name"),hint:game.i18n.localize("tokenActionHud.settings.rollHandler.hint"),scope:"world",config:!0,type:String,choices:n,default:"core",onChange:e=>{updateFunc()}}),game.settings.register(t,"style",{name:game.i18n.localize("tokenActionHud.settings.style.name"),hint:game.i18n.localize("tokenActionHud.settings.style.hint"),scope:"client",config:!0,type:String,default:"foundryVTT",choices:{compact:"Compact",foundryVTT:"Foundry VTT",dorakoUI:"Dorako UI"},onChange:e=>{switchCSS(e)}}),game.settings.register(t,"direction",{name:game.i18n.localize("tokenActionHud.settings.direction.name"),hint:game.i18n.localize("tokenActionHud.settings.direction.hint"),scope:"client",config:!0,type:String,default:"down",choices:{up:game.i18n.localize("tokenActionHud.settings.direction.choices.up"),down:game.i18n.localize("tokenActionHud.settings.direction.choices.down")},onChange:e=>{updateFunc()}}),game.settings.register(t,"scale",{name:game.i18n.localize("tokenActionHud.settings.scale.name"),hint:game.i18n.localize("tokenActionHud.settings.scale.hint"),scope:"client",config:!0,type:Number,range:{min:.5,max:2,step:.05},default:1,onChange:e=>{updateFunc()}}),game.settings.register(t,"drag",{name:game.i18n.localize("tokenActionHud.settings.drag.name"),hint:game.i18n.localize("tokenActionHud.settings.drag.hint"),scope:"client",config:!0,type:Boolean,default:!0,onChange:e=>{updateFunc()}}),initColorSettings(t),game.settings.register(t,"enable",{name:game.i18n.localize("tokenActionHud.settings.enable.name"),hint:game.i18n.localize("tokenActionHud.settings.enable.hint"),scope:"client",config:!0,type:Boolean,default:!0,onChange:e=>{updateFunc()}}),game.settings.register(t,"allow",{name:game.i18n.localize("tokenActionHud.settings.allow.name"),hint:game.i18n.localize("tokenActionHud.settings.allow.hint"),scope:"world",config:!0,type:String,choices:{4:game.i18n.localize("tokenActionHud.settings.allow.choices.4"),3:game.i18n.localize("tokenActionHud.settings.allow.choices.3"),2:game.i18n.localize("tokenActionHud.settings.allow.choices.2"),1:game.i18n.localize("tokenActionHud.settings.allow.choices.1")},default:1,onChange:foundry.utils.debounce((()=>window.location.reload()),100)}),game.settings.register(t,"alwaysShowHud",{name:game.i18n.localize("tokenActionHud.settings.alwaysShowHud.name"),hint:game.i18n.localize("tokenActionHud.settings.alwaysShowHud.hint"),scope:"client",config:!0,type:Boolean,default:!0,onChange:e=>{updateFunc()}}),game.settings.register(t,"displayCharacterName",{name:game.i18n.localize("tokenActionHud.settings.displayCharacterName.name"),hint:game.i18n.localize("tokenActionHud.settings.displayCharacterName.hint"),scope:"client",config:!0,type:Boolean,default:!0,onChange:e=>{updateFunc()}}),game.settings.register(t,"displayIcons",{name:game.i18n.localize("tokenActionHud.settings.displayIcons.name"),hint:game.i18n.localize("tokenActionHud.settings.displayIcons.hint"),scope:"client",config:!0,type:Boolean,default:!0,onChange:e=>{updateFunc()}}),game.settings.register(t,"clickOpenCategory",{name:game.i18n.localize("tokenActionHud.settings.clickOpenCategory.name"),hint:game.i18n.localize("tokenActionHud.settings.clickOpenCategory.hint"),scope:"client",config:!0,type:Boolean,default:!1,onChange:e=>{updateFunc()}}),game.settings.register(t,"renderItemOnRightClick",{name:game.i18n.localize("tokenActionHud.settings.renderItemOnRightClick.name"),hint:game.i18n.localize("tokenActionHud.settings.renderItemOnRightClick.hint"),scope:"client",config:!0,type:Boolean,default:!0,onChange:e=>{updateFunc()}}),game.modules.get("itemacro")?.active&&game.settings.register(t,"itemMacro",{name:game.i18n.localize("tokenActionHud.settings.itemMacro.name"),hint:game.i18n.localize("tokenActionHud.settings.itemMacro.hint"),scope:"client",config:!0,type:String,choices:{both:game.i18n.localize("tokenActionHud.settings.itemMacro.choices.both"),itemMacro:game.i18n.localize("tokenActionHud.settings.itemMacro.choices.itemMacro"),original:game.i18n.localize("tokenActionHud.settings.itemMacro.choices.original")},default:"both",onChange:e=>{updateFunc()}}),game.settings.register(t,"activeCssAsText",{name:game.i18n.localize("tokenActionHud.settings.activeCssAsText.name"),hint:game.i18n.localize("tokenActionHud.settings.activeCssAsText.hint"),scope:"client",config:!0,type:Boolean,default:!1,onChange:e=>{updateFunc()}}),game.settings.register(t,"debug",{name:game.i18n.localize("tokenActionHud.settings.debug.name"),hint:game.i18n.localize("tokenActionHud.settings.debug.hint"),scope:"client",config:!0,type:Boolean,default:!1,onChange:e=>{updateFunc()}}),game.settings.register(t,"reset",{name:game.i18n.localize("tokenActionHud.settings.reset.name"),hint:game.i18n.localize("tokenActionHud.settings.reset.hint"),scope:"client",config:!0,type:Boolean,default:!1,onChange:e=>{e&&(game.tokenActionHud.reset(),game.tokenActionHud.update(),setSetting("reset",!1))}}),i.doRegisterSettings(updateFunc),Logger.debug("Available roll handlers",{rollHandlers:n})};function initColorSettings(e){let t=null;switch(game.modules.get("lib-themer")?.active?t="lib-themer":game.modules.get("color-picker")?.active?t="color-picker":game.modules.get("colorsettings")?.active&&(t="colorsettings"),t){case"lib-themer":Hooks.once("lib-themer.Ready",(t=>{t.register({id:e,title:game.modules.get(e).title,"--tah-background":{name:"tokenActionHud.settings.background.name",hint:"tokenActionHud.settings.background.hint",type:"color",default:"#00000000"},"--tah-button":{name:"tokenActionHud.settings.buttonBackgroundColor.name",hint:"tokenActionHud.settings.buttonBackgroundColor.hint",type:"color",default:"#00000080",colors:{buttons:!0}}})}));break;case"color-picker":"object"==typeof ColorPicker?registerColorSettings(e,t):Hooks.once("colorPickerReady",(()=>{registerColorSettings(e,t)}));break;case"colorsettings":Hooks.once("ready",(()=>{try{window.Ardittristan.ColorSetting.tester,registerColorSettings(e,t)}catch{}}))}}function registerColorSettings(e,t){const i={key:"background",name:game.i18n.localize("tokenActionHud.settings.background.name"),hint:game.i18n.localize("tokenActionHud.settings.background.hint"),scope:"client",restricted:!1,default:"#00000000",onChange:e=>{document.querySelector(":root").style.setProperty("--tah-background",e),updateFunc()}},n={key:"buttonBackgroundColor",name:game.i18n.localize("tokenActionHud.settings.buttonBackgroundColor.name"),hint:game.i18n.localize("tokenActionHud.settings.buttonBackgroundColor.hint"),scope:"client",restricted:!0,default:"#00000080",onChange:e=>{document.querySelector(":root").style.setProperty("--tah-button",e),updateFunc()}},o={key:"buttonBorderColor",name:game.i18n.localize("tokenActionHud.settings.buttonBorderColor.name"),hint:game.i18n.localize("tokenActionHud.settings.buttonBorderColor.hint"),scope:"client",restricted:!0,default:"#000000ff",onChange:e=>{document.querySelector(":root").style.setProperty("--tah-button-outline",e),updateFunc()}};if("color-picker"===t){const t={format:"hexa",alphaChannel:!0};ColorPicker.register(e,i.key,{name:i.name,hint:i.hint,scope:i.scope,restricted:i.restricted,default:i.default,onChange:i.onChange},t),ColorPicker.register(e,n.key,{name:n.name,hint:n.hint,scope:n.scope,restricted:n.restricted,default:n.default,onChange:n.onChange},t),ColorPicker.register(e,o.key,{name:o.name,hint:o.hint,scope:o.scope,restricted:o.restricted,default:o.default,onChange:o.onChange},t)}else"colorsettings"===t&&(new window.Ardittristan.ColorSetting(e,i.key,{name:i.name,hint:i.hint,scope:i.scope,restricted:i.restricted,defaultColor:i.default,onChange:i.onChange,insertAfter:`${e}.scale`}),new window.Ardittristan.ColorSetting(e,n.key,{name:n.name,hint:n.hint,scope:n.scope,restricted:n.restricted,defaultColor:n.default,onChange:n.onChange,insertAfter:`${e}.${i.key}`}),new window.Ardittristan.ColorSetting(e,o.key,{name:o.name,hint:o.hint,scope:o.scope,restricted:o.restricted,defaultColor:o.default,onChange:o.onChange,insertAfter:`${e}.${n.key}`}));Hooks.once("ready",(()=>{document.querySelector(":root").style.setProperty("--tah-background",getSetting("background")??"#00000000"),document.querySelector(":root").style.setProperty("--tah-button",getSetting("buttonBackgroundColor")??"#00000080"),document.querySelector(":root").style.setProperty("--tah-button-outline",getSetting("buttonBorderColor")??"#000000ff")}))}class TagDialog extends Dialog{i18n=e=>game.i18n.localize(e);tagify=null;dragSort=null;constructor(e,t){super(t),this.data=e,this.categoryId=null,this.subcategoryId=null}static showDialog(e,t,i,n,o,a){this.nestId=e,TagDialog._prepareHook(t,i);const s=Handlebars.compile("{{> modules/token-action-hud-core/templates/tagdialog.hbs}}")(o);new TagDialog({title:n,content:s,buttons:{accept:{icon:'<i class="fas fa-check"></i>',label:game.i18n.localize("tokenActionHud.accept"),callback:async e=>{const t=TagDialog.tagify.value.map((e=>(e.id=e.id??e.value.slugify({replacement:"-",strict:!0}),{id:e.id,title:e.value,type:e.type,level:e.level})));await a(t,e)}},cancel:{icon:'<i class="fas fa-times"></i>',label:game.i18n.localize("tokenActionHud.cancel")}},default:"accept"}).render(!0)}static _prepareHook(e,t){Hooks.once("renderTagDialog",((i,n,o)=>{n.css("height","auto");const a=n.find('select[id="token-action-hud-index"]');a.length>0&&(a.css("background","#fff"),a.css("color","#000"));const s=n.find('input[class="token-action-hud-taginput"]');if(s.length>0){const c={delimiters:";",maxTags:"Infinity",dropdown:{maxItems:50,classname:"tags-look",enabled:0,closeOnSelect:!1}};function onDragEnd(e){TagDialog.tagify.updateValueByDOMTags()}e&&(c.whitelist=e),TagDialog.tagify=new Tagify(s[0],c),TagDialog.dragSort=new DragSort(TagDialog.tagify.DOM.scope,{selector:"."+TagDialog.tagify.settings.classNames.tag,callbacks:{dragEnd:onDragEnd}});const r=$(document).find(".tagify");r.css("background","#fff"),r.css("color","#000"),t&&TagDialog.tagify.addTags(t);n.find('button[class="tags--removeAllBtn"]').on("click",TagDialog.tagify.removeAllTags.bind(TagDialog.tagify))}}))}_onKeyDown(e){if("Escape"===e.key&&!e.target.className.includes("tagify"))return e.preventDefault(),e.stopPropagation(),this.close();if("Enter"===e.key&&this.data.default&&!e.target.className.includes("tagify")){e.preventDefault(),e.stopPropagation();const t=this.data.buttons[this.data.default];return this.submit(t)}}}class TagDialogHelper{static showCategoryDialog(e){TagDialogHelper._showCategoryDialog(e)}static _showCategoryDialog(e){const t=e.getSelectedCategoriesAsTagifyEntries(),i=game.i18n.localize("tokenActionHud.categoryTagTitle"),n={topLabel:game.i18n.localize("tokenActionHud.categoryTagExplanation"),placeholder:game.i18n.localize("tokenActionHud.filterPlaceholder"),clearButtonText:game.i18n.localize("tokenActionHud.clearButton"),indexExplanationLabel:game.i18n.localize("tokenActionHud.pushLabelExplanation")};TagDialog.showDialog(null,null,t,i,n,(async t=>{await TagDialogHelper.submitCategories(e,t)}))}static showSubcategoryDialog(e,t,i){TagDialogHelper._showSubcategoryDialog(e,t,i)}static async _showSubcategoryDialog(e,t,i){const n=await e.getSubcategoriesAsTagifyEntries(),o=await e.getSelectedSubcategoriesAsTagifyEntries(t),a=game.i18n.localize("tokenActionHud.subcategoryTagTitle")+` (${i})`,s={topLabel:game.i18n.localize("tokenActionHud.subcategoryTagExplanation"),placeholder:game.i18n.localize("tokenActionHud.filterPlaceholder"),clearButtonText:game.i18n.localize("tokenActionHud.clearButton"),advancedCategoryOptions:game.user.getFlag("token-action-hud-core",`categories.${t}.advancedCategoryOptions`)};TagDialog.showDialog(t,n,o,a,s,(async(i,n)=>{i=i.map((e=>(e.id=e.id??e.title.slugify({replacement:"-",strict:!0}),e.type=e.type??"custom",{id:e.id,title:e.title,type:e.type})));const o={customWidth:parseInt(n.find('input[name="custom-width"]').val()),compactView:n.find('input[name="compact-view"]').prop("checked"),characterCount:parseInt(n.find('input[name="character-count"]').val())};await TagDialogHelper.submitSubcategories(e,t,i,o)}))}static async showActionDialog(e,t,i,n){await TagDialogHelper._showActionDialog(e,t,i,n)}static async _showActionDialog(e,t,i,n){const o=await t.getActionsAsTagifyEntries(i),a=await e.getSubcategoriesAsTagifyEntries(),s=[];s.push(...o,...a);const c=await t.getSelectedActionsAsTagifyEntries(i),r=await e.getSelectedSubcategoriesAsTagifyEntries(i),l=[];l.push(...c,...r);const d=`${game.i18n.localize("tokenActionHud.filterTitle")} (${n})`,g={topLabel:game.i18n.localize("tokenActionHud.filterTagExplanation"),placeholder:game.i18n.localize("tokenActionHud.filterPlaceholder"),clearButtonText:game.i18n.localize("tokenActionHud.clearButton"),indexExplanationLabel:game.i18n.localize("tokenActionHud.blockListLabel")};TagDialog.showDialog(i,s,l,d,g,(async n=>{await TagDialogHelper.saveActions(e,t,i,n)}))}static async submitCategories(e,t){await e.submitCategories(t),Hooks.callAll("forceUpdateTokenActionHud")}static async submitSubcategories(e,t,i){await e.submitSubcategories(t,i),Hooks.callAll("forceUpdateTokenActionHud")}static async saveActions(e,t,i,n){const o=n.filter((e=>"subcategory"===e.level));await e.submitSubcategories(i,o);const a=n.filter((e=>"action"===e.level));await t.saveActions(i,a),Hooks.callAll("forceUpdateTokenActionHud")}}class CategoryResizer{static resizeHoveredCategory(e){if(!e)return;const t=e.querySelectorAll(".tah-actions");if(0===t.length)return;const i=e.querySelector(".tah-subcategories"),n=e.id.replace("tah-category-",""),o=game.user.getFlag("token-action-hud-core",`categories.${n}.advancedCategoryOptions.customWidth`);if(o)return void(i.style.width=`${o}px`);const a=document.querySelector("#sidebar"),s=document.querySelector("#hotbar"),c=canvas.screenDimensions[0],r=canvas.screenDimensions[1],l=i.getBoundingClientRect(),d=getComputedStyle(i),g=l.top,u=l.left,h=parseInt(d.paddingLeft)||0+parseInt(d.paddingRight)||0,m=a.offsetLeft,f=a.clientWidth,p=(m>0?c-(m+f):c)-20-u,y=s.offsetTop,b=(y>0?y:r)-20;let k=null,A=0,H=0,C=0;for(const e of t){const t=e.querySelectorAll(".tah-action");if(t.length>0){(t.length<k||null===k)&&(k=t.length),C+=t.length;let e=0;for(const i of Array.from(t)){const t=i.getBoundingClientRect(),n=Math.ceil(t.width);e+=n,H+=n}const i=5*t.length;H+=i,e+=i,e>A&&(A=e)}}A+=h,H+=h;const v=Math.ceil(H/C);let w=5;const S=Math.floor(p/v);k<S&&k>w&&k<10&&(w=k),S<w&&(w=S);let T=v*w;T>A&&(T=A),T<200&&(T=200);const L=r-g-(r-b),M=L<100?100:L;i.style.width=`${T}px`,i.style.maxHeight=Math.ceil(M)+"px"}}class TokenActionHud extends Application{i18n=e=>game.i18n.localize(e);hoveredCategoryId="";defaultHeight=200;defaultWidth=20;defaultLeftPos=150;defaultTopPos=80;defaultScale=1;isDebug=null;refreshTimeout=null;rendering=!1;tokens=null;constructor(e){super(),this.systemManager=e}async init(e){this.isDebug=getSetting("debug"),await this.systemManager.registerDefaultFlags(),this.categoryManager=await this.systemManager.getCategoryManager(e),this.actionHandler=await this.systemManager.getActionHandler(e),this.rollHandler=this.systemManager.getRollHandler()}updateSettings(){this.updateRollHandler(),this.update()}updateRollHandler(){this.rollHandler=this.systemManager.getRollHandler()}setTokens(e){this.tokens=e}static get defaultOptions(){return mergeObject(super.defaultOptions,{template:"/modules/token-action-hud-core/templates/template.hbs",id:"token-action-hud",classes:[],width:this.defaultWidth,height:this.defaultHeight,left:this.defaultLeftPos,top:this.defaultTopPos,scale:this.defaultScale,background:"none",popOut:!1,minimizable:!1,resizable:!1,title:"token-action-hud",dragDrop:[],tabs:[],scrollY:[]})}getScale(){const e=parseFloat(getSetting("scale"));return e<.5?.5:e>2?2:e}getData(e={}){const t=super.getData();t.actions=this.actionList,t.id="token-action-hud",t.scale=this.getScale(),t.background=getSetting("background")??"#00000000",Logger.debug("Application data",{data:t});for(const i of t.actions.categories){const n=game.user.getFlag("token-action-hud-core",`categories.${i.id}.advancedCategoryOptions`);if(!n?.compactView)continue;const o=n.characterCount??2;function subcatRecursion(e){for(const t of e.subcategories){for(const e of t.actions)e.title=e.name,e.name.length<2||(e.name=0===o?"":e.name.split(" ").map((e=>e.slice(0,o))).join(" "));t.subcategories.length&&t.subcategories.forEach((e=>subcatRecursion(e)))}}i.subcategories&&subcatRecursion(i)}return t}activateListeners(e){const t="#tah-categories",i=e.find(".tah-category"),n=e.find(".tah-subcategory"),o="#tah-edit-categories",a="#tah-unlock",s="#tah-lock",c=".tah-title-button",r=e.find(c),l=e.find(".tah-subtitle"),d="#tah-collapse-hud",g="#tah-expand-hud",u="#tah-buttons";function closeCategory(e){if(game.tokenActionHud.rendering)return;this.classList.remove("hover");const t=this.id;game.tokenActionHud.clearHoveredCategory(t)}function openCategory(e){this.classList.add("hover");const t=this.id;game.tokenActionHud.setHoveredCategory(t),CategoryResizer.resizeHoveredCategory(this)}function toggleCategory(e){let t;if(this.parentElement.classList.contains("hover"))t=closeCategory.bind(this.parentElement),t(e);else{for(const e of i)e.classList.remove("hover");t=openCategory.bind(this.parentElement),t(e)}}function collapseHud(i=null){i&&(i.preventDefault(),i=i||window.event);const n=i?.target||e.find(d);$(n).addClass("tah-hidden"),e.find(g).removeClass("tah-hidden"),e.find(t).addClass("tah-hidden"),e.find(u).addClass("tah-hidden"),i&&game.user.setFlag("token-action-hud-core","isCollapsed",!0)}async function unlockHud(t=null){t&&(t.preventDefault(),t=t||window.event);const c=t?.target||e.find(a);$(c).addClass("tah-hidden"),e.find(s).removeClass("tah-hidden"),e.find(o).removeClass("tah-hidden"),i.removeClass("tah-hidden"),n.removeClass("tah-hidden"),r.removeClass("disable-edit"),l.removeClass("disable-edit"),t&&await game.user.setFlag("token-action-hud-core","isUnlocked",!0)}async function lockHud(t=null){t&&(t.preventDefault(),t=t||window.event);const c=t?.target||e.find(s);$(c).addClass("tah-hidden"),e.find(a).removeClass("tah-hidden"),e.find(o).addClass("tah-hidden");for(const e of i){e.getElementsByClassName("tah-action").length>0||$(e).addClass("tah-hidden")}for(const e of n){e.getElementsByClassName("tah-action").length>0||$(e).addClass("tah-hidden")}r.addClass("disable-edit"),l.addClass("disable-edit"),t&&await game.user.setFlag("token-action-hud-core","isUnlocked",!1)}game.user.getFlag("token-action-hud-core","isCollapsed")&&collapseHud(),game.user.getFlag("token-action-hud-core","isUnlocked")?unlockHud():lockHud(),e.find(c).on("click",(()=>this.bringToTop())),e.find(c).on("contextmenu",(e=>{game.user.getFlag("token-action-hud-core","isUnlocked")&&function openSubcategoryDialog(e){const t=e.target;if(0===t.value.length)return;const i=t.value,n=t.innerText??t.outerText;TagDialogHelper.showSubcategoryDialog(game.tokenActionHud.categoryManager,i,n)}(e)})),e.find(".tah-subtitle").on("click contextmenu",(e=>{game.user.getFlag("token-action-hud-core","isUnlocked")&&function openActionDialog(e){const t=e.target;if(0===t.id.length)return;const i=t.id,n=t.innerText??t.outerText;TagDialogHelper.showActionDialog(game.tokenActionHud.categoryManager,game.tokenActionHud.actionHandler,i,n)}(e)})),e.find(".tah-action").on("mousedown contextmenu",(e=>{e.preventDefault(),function handleAction(e){let t=e.target;"BUTTON"!==t.tagName&&(t=e.currentTarget.children[0]);const i=t.value;try{game.tokenActionHud.rollHandler.handleActionEvent(e,i),t.blur()}catch(t){Logger.error(e)}}(e)})),e.find(o).on("click",(e=>{e.preventDefault(),e=e||window.event,TagDialogHelper._showCategoryDialog(this.categoryManager)})),getSetting("clickOpenCategory")?e.find(c).on("click",toggleCategory):(e.find(c).on("touchstart",toggleCategory),e.find(".tah-category").hover(openCategory,closeCategory)),e.find(c).on("mousedown",(e=>this.dragEvent(e))),e.find(c).on("touchstart",(e=>this.dragEvent(e))),e.find(d).on("click",(e=>collapseHud(e))),e.find(g).on("click",(i=>function expandHud(i){i.preventDefault(),i=i||window.event,$(i.target).addClass("tah-hidden"),e.find(d).removeClass("tah-hidden"),e.find(t).removeClass("tah-hidden"),e.find(u).removeClass("tah-hidden"),game.user.setFlag("token-action-hud-core","isCollapsed",!1)}(i))),e.find(g).on("mousedown",(e=>this.dragEvent(e))),e.find(g).on("touchstart",(e=>this.dragEvent(e))),e.find(a).on("click",(e=>unlockHud(e))),e.find(s).on("click",(e=>lockHud(e))),$(document).find(".tah-filterholder").parents(".tah-subcategory").css("cursor","pointer")}dragEvent(e){if(!getSetting("drag"))return;const t=e.target.parentElement.closest("div#token-action-hud");document.onmousemove=mouseMoveEvent,document.onmouseup=mouseUpEvent,t.ontouchmove=mouseMoveEvent,t.ontouchend=mouseUpEvent;const i=e.clientX??e.changedTouches[0].clientX,n=e.clientY??e.changedTouches[0].clientY;let o=0,a=0,s=i,c=n;const r=t.offsetTop,l=t.offsetLeft;let d=r,g=l;function mouseMoveEvent(e){const i=(e=e||window.event).clientX??e.changedTouches[0].clientX,n=e.clientY??e.changedTouches[0].clientY;o=s-i,a=c-n,s=i,c=n,o===s&&a===c||(d-=a,g-=o,t.style.top=d+"px",t.style.left=g+"px",t.style.position="fixed")}function mouseUpEvent(){document.onmousemove=null,document.onmouseup=null,t.ontouchmove=null,t.ontouchend=null,d===r&&g===l||(game.user.update({flags:{"token-action-hud-core":{position:{top:d,left:g}}}}),Logger.debug(`Set position to x: ${d}px, y: ${g}px`))}}applySettings(){"up"===getSetting("direction")&&($(document).find(".tah-subcategories").removeClass("expand-down"),$(document).find(".tah-subcategories").addClass("expand-up"),$(document).find("#tah-character-name").addClass("tah-hidden"))}setPosition(){if(!this.actionList)return;const e=$(document).find("#tah-character-name");e.length>0&&e.css("top",-e[0].getBoundingClientRect().height),canvas?.tokens?.placeables.find((e=>e.id===this.actionList?.tokenId)),this.setPositionFromFlag(),this.restoreHoveredCategoryState(),this.rendering=!1}setPositionFromFlag(){if(!game.user.flags["token-action-hud-core"].position)return;const e=game.user.flags["token-action-hud-core"].position,t=this.defaultLeftPos,i=this.defaultTopPos;return new Promise((n=>{!function check(){const o=document.getElementById("token-action-hud");o?(o.style.bottom=null,o.style.top=e.top<5||e.top>window.innerHeight+5?i+"px":e.top+"px",o.style.left=e.left<5||e.left>window.innerWidth+5?t+"px":e.left+"px",o.style.position="fixed",n()):setTimeout(check,30)}()}))}setPositionFromToken(e){return new Promise((t=>{!function check(e){const i=$("#token-action-hud");i?(i.css("bottom",null),i.css("left",e.worldTransform.tx+(e.width*canvas.dimensions.size+55)*canvas.scene._viewPosition.scale+"px"),i.css("top",e.worldTransform.ty+0+"px"),i.css("position","fixed"),t()):setTimeout(check,30)}(e)}))}resetPosition(){Logger.debug("Resetting position..."),game.user.update({flags:{"token-action-hud-core":{position:{top:this.defaultTopPos,left:this.defaultLeftPos}}}}),this.update(),Logger.debug(`Position reset to x: ${this.defaultTopPos}px, y: ${this.defaultLeftPos}px`)}setHoveredCategory(e){this.hoveredCategoryId=e}clearHoveredCategory(e){this.hoveredCategoryId===e&&(this.hoveredCategoryId="")}restoreHoveredCategoryState(){if(""===this.hoveredCategoryId)return;const e=`#${this.hoveredCategoryId}`,t=$(e);if(t[0])if(getSetting("clickOpenCategory")){t.find(".tah-title-button")[0].click()}else t.mouseenter()}async reset(){await this.resetUserFlags(),this.resetPosition()}async resetActorFlags(){await this.categoryManager.resetActorFlags(),this.update()}async resetUserFlags(){await this.categoryManager.resetUserFlags(),this.update()}update(){this._updateHud()}async _updateHud(){Logger.debug("Updating hud...");const e=this.tokens?.controlled,t=this._getCharacter(e),i=e.length>1&&!t;(t||i)&&this.isHudEnabled()?(this.actionList=await this.actionHandler.buildActionList(t),this.rendering=!0,this.render(!0),Logger.debug("Hud updated")):this.close()}isValidTokenChange(e,t=null){return!t?.actorData?.flags&&(getSetting("alwaysShowHud")?this.isRelevantToken(e)||e.actorId===game.user.character?.id:this.isRelevantToken(e))}isRelevantToken(e){const t=this.tokens?.controlled;return t?.some((t=>t.id===e.id))||0===t?.length&&canvas?.tokens?.placeables?.some((e=>e.id===this.actionList?.tokenId))}isValidActorOrItemUpdate(e,t){return t?.flags?(Logger.debug("Flags set, do not update hud",{actor:e,data:t}),!1):e?e?this.actionList&&e.id===this.actionList.actorId?(Logger.debug("Same actor, update hud",{actor:e,data:t}),!0):(Logger.debug("Different actor, do not update hud",{actor:e,data:t}),!1):(Logger.debug("No actor, update hud",{data:t}),!0):void 0}isHudEnabled(){const e=game.user.role,t=game.user.isGM,i=getSetting("allow"),n=checkAllow(e),o=getSetting("enable");return Logger.debug("isHudEnabled()",{isGM:t,userRole:e,allowRole:i,isAllowed:n,isEnabled:o}),!!o&&(n||t)}isLinkedCompendium(e){return Logger.debug("Compendium hook triggered, checking if compendium is linked..."),this.categoryManager.isLinkedCompendium(e)}_getCharacter(e=[]){if(e.length>1)return null;let t;if(1===e.length){const i=e[0],n=i.actor;if(!this._isValidCharacter(i))return null;if(t={token:i,actor:n},t.id=i?.id??n?.id,t.name=i?.name??n?.name,t.id)return t}if(0===e.length&&game.user.character){if(!getSetting("alwaysShowHud"))return null;const e=game.user.character,i=canvas?.tokens?.placeables.find((t=>t.actor?.id===e?.id));if(t={token:i??null,actor:e},t.id=i?.id??e.id,t.name=i?.name??e.name,t.id)return t}return null}_isValidCharacter(e=""){const t=e.actor,i=game.user;return game.user.isGM||t?.testUserPermission(i,"OWNER")}}let i;Hooks.on("ready",(async()=>{const e=game.system.id,t=`token-action-hud-${e}`,n=game.modules.get("token-action-hud-core").version,o=`../../${t}/enums/core-version.js`,a=await import(o).then((e=>e.coreModuleVersion));if(n!==a)return void ui.notifications.error(`The installed Token Action Hud system module requires Token Action Hud core module version ${a}.`);const s=`../../${t}/scripts/${t}.min.js`,c=(await import(s)).SystemManager;if(!c)return void ui.notifications.error("Token Action Hud system module not found.");const r=`token-action-hud-${e}`;game.modules.get(r)?.active?(i=new c("token-action-hud-core"),i.registerSettings(),switchCSS(getSetting("style")),registerHandlebars(),loadTemplates(["modules/token-action-hud-core/templates/category.hbs","modules/token-action-hud-core/templates/subcategory.hbs","modules/token-action-hud-core/templates/action.hbs","modules/token-action-hud-core/templates/tagdialog.hbs"]),Hooks.callAll("tokenActionHudInitialized")):ui.notifications.error("Token Action Hud system module is not active.")})),Hooks.on("canvasReady",(async()=>{Hooks.on("tokenActionHudInitialized",(async()=>{if(game.user.isGM&&!game.modules.get("lib-themer")?.active&&!game.modules.get("color-picker")?.active&&!game.modules.get("colorsettings")?.active){!1===getSetting("startup")&&(ui.notifications.notify("Token Action Hud: To set colors within this module's settings, install and enable one of the following 'Color Picker', 'Color Settings' or 'libThemer' modules."),setSetting("startup",!0))}const e=game.user;game.tokenActionHud||(game.tokenActionHud=new TokenActionHud(i),await game.tokenActionHud.init(e)),game.tokenActionHud.setTokens(canvas.tokens),Hooks.on("controlToken",((e,t)=>{game.tokenActionHud.update()})),Hooks.on("updateToken",((e,t,i)=>{Object.hasOwn(i,"y")||Object.hasOwn(i,"x")||game.tokenActionHud.isValidTokenChange(e,t)&&game.tokenActionHud.update()})),Hooks.on("deleteToken",((e,t,i,n)=>{game.tokenActionHud.isValidTokenChange(t)&&game.tokenActionHud.update()})),Hooks.on("updateActor",((e,t)=>{game.tokenActionHud.isValidActorOrItemUpdate(e,t)&&game.tokenActionHud.update()})),Hooks.on("deleteActor",((e,t)=>{game.tokenActionHud.isValidActorOrItemUpdate(e,t)&&game.tokenActionHud.update()})),Hooks.on("deleteItem",(e=>{const t=e.actor;game.tokenActionHud.isValidActorOrItemUpdate(t)&&game.tokenActionHud.update()})),Hooks.on("createItem",(e=>{const t=e.actor;game.tokenActionHud.isValidActorOrItemUpdate(t)&&game.tokenActionHud.update()})),Hooks.on("updateItem",(e=>{const t=e.actor;game.tokenActionHud.isValidActorOrItemUpdate(t)&&game.tokenActionHud.update()})),Hooks.on("renderTokenActionHud",(()=>{game.tokenActionHud.applySettings()})),Hooks.on("renderCompendium",((e,t)=>{const i=e?.metadata;game.tokenActionHud.isLinkedCompendium(`${i?.package}.${i?.name}`)&&game.tokenActionHud.update()})),Hooks.on("deleteCompendium",((e,t)=>{const i=e?.metadata;game.tokenActionHud.isLinkedCompendium(`${i?.package}.${i?.name}`)&&game.tokenActionHud.update()})),Hooks.on("createCombat",(e=>{game.tokenActionHud.update()})),Hooks.on("deleteCombat",(e=>{game.tokenActionHud.update()})),Hooks.on("updateCombat",(e=>{game.tokenActionHud.update()})),Hooks.on("updateCombatant",((e,t)=>{game.tokenActionHud.update()})),Hooks.on("forceUpdateTokenActionHud",(()=>{game.tokenActionHud.update()})),Hooks.on("createActiveEffect",(()=>{game.tokenActionHud.update()})),Hooks.on("deleteActiveEffect",(()=>{game.tokenActionHud.update()})),game.tokenActionHud.update()}))}));class ActionList{constructor(e="",t="",i=""){this.hudTitle=e,this.tokenId=t,this.actorId=i,this.categories=[]}}class ActionCategory{constructor(e="",t=""){this.id=e,this.nestId=e,this.name=t,this.level="category",this.cssClass="",this.subcategories=[]}}class ActionSubcategory{constructor(e="",t="",i="",n=""){this.id=e,this.nestId=t,this.name=i,this.type=n,this.level="subcategory",this.info1="",this.actions=[],this.subcategories=[]}}class GenericActionHandler{baseHandler;constructor(e){this.baseHandler=e}buildGenericActions(e,t){this._buildConditions(e,t),this._buildUtilities(e,t)}_buildConditions(e,t){}_buildUtilities(e,t){t?this._buildSingleTokenUtilities(e,t):this._buildMultipleTokenUtilities(e)}_buildSingleTokenUtilities(e,t){const i=t.actor?.id,n=t.token?.id;if(!n)return;const o="utility",a=[],s="toggleCombat",c=canvas.tokens.placeables.find((e=>e.id===n)).inCombat?this.baseHandler.i18n("tokenActionHud.removeFromCombat"):this.baseHandler.i18n("tokenActionHud.addToCombat"),r=[o,i,n,s].join(this.baseHandler.delimiter),l={id:s,name:c,encodedValue:r,selected:!0};if(a.push(l),game.user.isGM){const e="toggleVisibility",t=canvas.tokens.placeables.find((e=>e.id===n)).document.hidden?this.baseHandler.i18n("tokenActionHud.makeVisible"):this.baseHandler.i18n("tokenActionHud.makeInvisible"),s=[o,i,n,e].join(this.baseHandler.delimiter),c={id:e,name:t,encodedValue:s,selected:!0};a.push(c)}this.baseHandler.addActionsToActionList(e,a,"token")}_buildMultipleTokenUtilities(e){const t="utility",i="multi",n="multi",o=canvas.tokens.controlled,a=[],s="toggleCombat",c=o.every((e=>e.inCombat))?this.baseHandler.i18n("tokenActionHud.removeFromCombat"):this.baseHandler.i18n("tokenActionHud.addToCombat"),r=[t,i,n,s].join(this.baseHandler.delimiter),l={id:s,name:c,encodedValue:r};if(a.push(l),game.user.isGM){const e="toggleVisibility",s=o.every((e=>!e.document.hidden))?this.baseHandler.i18n("tokenActionHud.makeVisible"):this.baseHandler.i18n("tokenActionHud.makeInvisible"),c=[t,i,n,e].join(this.baseHandler.delimiter),r={id:e,name:s,encodedValue:c};a.push(r)}this.baseHandler.addActionsToActionList(e,a,"token")}}class CompendiumActionHandler{baseHandler;constructor(e){this.baseHandler=e}async buildCompendiumActions(e){const t=Object.values(e.categories).filter((e=>e.subcategories)).flatMap((e=>Object.values(e.subcategories).filter((e=>"compendium"===e.type)).flatMap((e=>e.id)))),i=game.packs.filter((e=>["JournalEntry","Macro","RollTable","Playlist"].includes(e.documentName))).filter((e=>game.user.isGM||!e.private)).map((e=>e.metadata.id));for(const n of i){const i=n.replace(".","-");if(t.includes(n.replace(".","-"))){const t=await this.getCompendiumActions(n);this.baseHandler.addActionsToActionList(e,t,i)}}}async getCompendiumActions(e){const t=await this.getCompendiumEntries(e),i=this.getCompendiumActionType(e);return t.map((t=>({id:t._id,name:t.name,encodedValue:[i,e,t._id].join(this.baseHandler.delimiter),img:this.baseHandler.getImage(t),selected:!0})))}async getCompendiumEntries(e){const t=game.packs.get(e);if(!t)return[];const i=t.index.size>0?t.index:await t.getIndex();if("Playlist"===t.documentName){return await this._getPlaylistEntries(t)}return i}async _getPlaylistEntries(e){return(await e.getContent()).reduce(((e,t)=>(t.sounds.forEach((i=>{e.push({_id:`${t._id}>${i._id}`,name:i.name})})),e)),[])}getCompendiumActionType(e){const t=game?.packs?.get(e);if(!t)return"";switch(t.documentName){case"Macro":return"compendiumMacro";case"Playlist":return"compendiumPlaylist";default:return"compendiumEntry"}}}class MacroActionHandler{baseHandler;constructor(e){this.baseHandler=e}async buildMacroActions(e){const t=Object.values(e.categories).filter((e=>e.subcategories)).flatMap((e=>Object.values(e.subcategories).filter((e=>"custom"===e.type)).flatMap((e=>e.id))));if(!t)return;const i=await this.getActions();for(const n of t)this.baseHandler.addActionsToActionList(e,i,n)}async getActions(){const e="macro";return game.macros.filter((e=>{const t=e.ownership;return t[game.userId]?t[game.userId]>0:t.default>0})).map((t=>({id:t.id,name:t.name,encodedValue:[e,t.id].join(this.baseHandler.delimiter),img:this.baseHandler.getImage(t),selected:!0})))}}class ActionHandler{i18n=e=>game.i18n.localize(e);furtherActionHandlers=[];delimiter="|";constructor(e,t){this.character=e,this.categoryManager=t,this.genericActionHandler=new GenericActionHandler(this),this.compendiumActionHandler=new CompendiumActionHandler(this),this.macroActionHandler=new MacroActionHandler(this),this.actionList=[],this.savedUserActionList=[],this.savedActorActionList=[],this.displayIcons=getSetting("displayIcons")}async buildActionList(e){Logger.debug("Building action list...",{character:e}),this.character=e,this.savedUserActionList=this.getSavedUserActionList(e),this.savedActorActionList=this.getSavedActorActionList(e);const t=this.buildEmptyActionList(e);return this.actionList=t,await Promise.all([this._buildSystemActions(this.actionList,e),this._buildGenericActions(this.actionList,e),this._buildCompendiumActions(this.actionList),this._buildMacroActions(this.actionList),this.buildFurtherActions(this.actionList,e)]),await this.saveActionList(this.actionList,e),Logger.debug("Action list built",{actionList:this.actionList,character:e}),this.actionList}getSavedUserActionList(e){Logger.debug("Retrieving saved action list  from user...",{character:e});const t=game.user.getFlag("token-action-hud-core","categories");if(!t)return[];const i=t;return Logger.debug("Saved action list from user retrieved",{savedUserActionList:i,character:e}),i}getSavedActorActionList(e){Logger.debug("Retrieving saved action list from actor...",{character:e});const t=e?.actor;if(!t)return[];const i=t.getFlag("token-action-hud-core","categories");if(!i)return[];const n=i;return Logger.debug("Saved action list from actor retrieved",{savedActorActionList:n,character:e}),n}buildEmptyActionList(e){Logger.debug("Building empty action list...",{character:e});let t="";getSetting("displayCharacterName")&&(t=e?.name??"Multiple");const i=new ActionList(t,e?.token?.id??"multi",e?.actor?.id??"multi"),n=game.user.flags["token-action-hud-core"]?.categories??game.user.flags["token-action-hud-core"]?.default.categories;for(const o of Object.entries(n)){i.categories.push(new ActionCategory(o[1].id,o[1].title));const a=i.categories.length-1;function addSubcategories(e,t,i){if(t)for(const i of Object.entries(t))if(e.subcategories.push(new ActionSubcategory(i[1].id,i[0],i[1].title,i[1].type)),i[1].subcategories){const t=e.subcategories.length-1;addSubcategories(e.subcategories[t],i[1].subcategories,i[0])}}addSubcategories(i.categories[a],o[1].subcategories,o[0])}return Logger.debug("Empty action list built",{emptyActionList:i,character:e}),i}async _buildSystemActions(e,t){Logger.debug("Building system actions...",{emptyActionList:e,character:t});const i=e,n=Object.values(i.categories).filter((e=>e.subcategories)).flatMap((e=>Object.values(e.subcategories).filter((e=>"system"===e.type)).flatMap((e=>e.id))));return await this.buildSystemActions(i,t,n),Logger.debug("System actions built",{actionList:i,character:t}),i}async buildSystemActions(e,t,i){}_buildGenericActions(e,t){Logger.debug("Building generic actions...",{actionList:e,character:t}),this.genericActionHandler.buildGenericActions(e,t),Logger.debug("Generic actions built...",{actionList:e,character:t})}async _buildCompendiumActions(e){Logger.debug("Building compendium actions...",{actionList:e}),await this.compendiumActionHandler.buildCompendiumActions(e),Logger.debug("Compendium actions built",{actionList:e})}async _buildMacroActions(e){Logger.debug("Building macro actions...",{actionList:e}),await this.macroActionHandler.buildMacroActions(e),Logger.debug("Macro actions built",{actionList:e})}buildFurtherActions(e,t){this.furtherActionHandlers.forEach((i=>i.extendActionList(e,t)))}async getActionsAsTagifyEntries(e){if(!this.actionList)return;return(await getSubcategoryByNestId(this.actionList.categories,e)).actions.map((e=>this.toTagifyEntry(e)))}async getSelectedActionsAsTagifyEntries(e){if(!this.actionList)return;return(await getSubcategoryByNestId(this.actionList.categories,e)).actions.filter((e=>!0===e.selected)).map((e=>this.toTagifyEntry(e)))}async registerDefaultCategories(){}addSubcategoryInfo(e,t,i){getSubcategoriesById(Object.values(e.categories).flatMap((e=>e.subcategories)),t).forEach((e=>{e.info1=i.info1,e.info2=i.info2,e.info3=i.info3}))}addToSubcategoryList(e,t,i,n=[]){e.push({subcategoryId:t,subcategory:i,actions:n})}addSubcategoriesToActionList(e,t,i){getSubcategoriesById(Object.values(e.categories).flatMap((e=>e.subcategories)),i).forEach((e=>{const i=e.nestId,n=deepClone(t).map((e=>e.subcategory));n.forEach((e=>{e.nestId=`${i}_${e.nestId}`})),e.subcategories.push(...n)}));const n=deepClone(t);for(const t of n){if(!t.actions)return;this.addActionsToActionList(e,t.actions,t.subcategoryId)}}async addActionsToActionList(e,t,i){if(0===t.length)return;const n=getSubcategoriesById(e.categories,i);for(const e of n){const i=(await getSubcategoryByNestId(this.savedActorActionList,e.nestId))?.actions??[],n=[];for(const e of i){const i=t.find((t=>t.encodedValue===e.encodedValue));if(i){const t=structuredClone(i);t.selected=e.selected??!0,n.push(t)}}for(const e of t){if(!i.find((t=>t.encodedValue===e.encodedValue))){const t=structuredClone(e);t.selected=!0,n.push(t)}}e.actions=n}}async saveActionList(e,t){if(Logger.debug("Saving action list...",{actionList:e,character:t}),!t?.actor)return;const i=t.actor;await i.unsetFlag("token-action-hud-core","categories"),await i.setFlag("token-action-hud-core","categories",e.categories),Logger.debug("Action list saved",{actionList:e,character:t})}async saveActions(e,t){const i=await getSubcategoryByNestId(this.actionList.categories,e),n=i.actions,o=[];for(const e of t){const t=n.find((t=>t.encodedValue===e.id));if(t){const e=structuredClone(t);e.selected=!0,o.push(e)}}for(const e of n){if(!t.find((t=>t.id===e.encodedValue))){const t=structuredClone(e);t.selected=!1,o.push(t)}}i.actions=o,await this.saveActionList(this.actionList,this.character)}addFurtherActionHandler(e){Logger.debug("Adding further action handler...",{handler:e}),this.furtherActionHandlers.push(e)}initializeEmptyCategory(e){const t=new ActionCategory;return t.id=e,t}initializeEmptySubcategory(e="",t="",i="",n=""){return new ActionSubcategory(e,t,i,n)}toTagifyEntry(e){return{id:e.encodedValue,value:e.name,type:"action",level:"action"}}getImage(e,t=[]){t.push("icons/svg/mystery-man.svg");let i="";return this.displayIcons&&(i=e?.img??e?.icon??""),t.includes(i)?"":i}sortItems(e){return(e=Object.values(e)).sort(((e,t)=>e.sort-t.sort)),e}}class ActionListExtender extends ActionHandler{extendActionList(e,t){}}class ItemMacroActionListExtender extends ActionListExtender{static isModuleActive(e){const t=game.modules.get(e);return t&&t.active}extendActionList(e,t){if(!t)return;const i=t.token?.id,n=t.actor?.id;if(!n)return;const o=this.getActor(n,i).items.filter((e=>e.flags?.itemacro?.macro?.command));let a;if(a=ItemMacroActionListExtender.isModuleActive("midi-qol")?o.filter(this.isUnsupportedByMidiQoL).map((e=>e.id)):o.map((e=>e.id)),!a)return;if(0===a.length)return;const s=getSetting("itemMacro");if("original"===s)return e;const c="itemMacro"===s;return e.categories.forEach((e=>{e.subcategories.forEach((e=>{this.addSubcategoryActions(a,e,c)}))})),e}addSubcategoryActions(e,t,i){t.subcategories&&t.subcategories.length>0&&t.subcategories.forEach((t=>this.addSubcategoryActions(e,t,i)));const n=[];t.actions.forEach((t=>{if(!e.includes(t.id))return;const o=this.createItemMacroAction(t,i);i||n.push(o)})),this.addActionsToSubcategory(t,n)}createItemMacroAction(e,t){const i=t?e:{},n=e.encodedValue.substr(e.encodedValue.indexOf(this.delimiter));return i.encodedValue="itemMacro"+n,i.id=e.id,i.name=`(M) ${e.name}`,i.img=e.img,i.icon=e.icon,i.info1=e.info1,i.info2=e.info2,i.info3=e.info3,i.selected=e.selected,i}addActionsToSubcategory(e,t){t.forEach((t=>{const i=e.actions.findIndex((e=>e.id===t.id))+1;e.actions.splice(i,0,t)}))}isUnsupportedByMidiQoL(e){return!e.getFlag("midi-qol","onUseMacroName")}getActor(e,t){let i=null;return t&&(i=canvas.tokens.placeables.find((e=>e.id===t))),i?i.actor:game.actors.get(e)}}class RollHandler{preRollHandlers=[];i18n=e=>game.i18n.localize(e);getActor(e,t){let i=null;return t&&(i=canvas.tokens.placeables.find((e=>e.id===t))),i?i.actor:game.actors.get(e)}getItem(e,t){return e.items.get(t)}getToken(e){return canvas.tokens.placeables.find((t=>t.id===e))}throwInvalidValueErr(e){throw new Error(`Error handling button click: ${e}`)}async handleActionEvent(e,t){Logger.debug(`Handling event for action [${t}]`,{event:e}),this.registerKeyPresses(e);let i=!1;this.preRollHandlers.forEach((n=>{i||(i=n.prehandleActionEvent(e,t))})),i||(this._isMultiGenericAction(t)?await this._doMultiGenericAction(t):this.doHandleActionEvent(e,t))}doHandleActionEvent(e,t){}addPreRollHandler(e){Logger.debug(`Adding pre-roll handler ${e.constructor.name}`),this.preRollHandlers.push(e)}registerKeyPresses(e){this.rightClick=this.isRightClick(e),this.ctrl=this.isCtrl(e),this.alt=this.isAlt(e),this.shift=this.isShift(e)}doRenderItem(e,t,i){const n=this.getActor(e,t);this.getItem(n,i).sheet.render(!0)}isRenderItem(){return getSetting("renderItemOnRightClick")&&this.rightClick&&!(this.alt||this.ctrl||this.shift)}isRightClick(e){return 2===e?.originalEvent?.button}isAlt(e){return game.keyboard.isModifierActive(KeyboardManager.MODIFIER_KEYS.ALT)}isCtrl(e){return game.keyboard.isModifierActive(KeyboardManager.MODIFIER_KEYS.CONTROL)}isShift(e){return game.keyboard.isModifierActive(KeyboardManager.MODIFIER_KEYS.SHIFT)}_isMultiGenericAction(e){const t=e.split("|"),i=t[0],n=t[3];return"utility"===i&&n.includes("toggle")}async _doMultiGenericAction(e){const t=e.split("|")[3];"toggleVisibility"===t&&await canvas.tokens.controlled[0].toggleVisibility(),"toggleCombat"===t&&await canvas.tokens.controlled[0].toggleCombat(),Hooks.callAll("forceUpdateTokenActionHud")}}class PreRollHandler extends RollHandler{prehandleActionEvent(e,t){return!1}}class CompendiumMacroPreHandler extends PreRollHandler{prehandleActionEvent(e,t){const i=game.tokenActionHud.actionHandler.delimiter,n=t.split(i);if(n.length<2)return!1;let o=null,a=null,s=null;if(2===n.length&&(o=n[0],s=n[1]),3===n.length&&(o=n[0],a=n[1],s=n[2]),!["compendiumEntry","compendiumMacro","compendiumPlaylist","macro"].includes(o))return!1;switch(o){case"compendiumEntry":this.handleCompendium(a,s);break;case"compendiumMacro":this.handleMacroCompendium(a,s);break;case"compendiumPlaylist":this.handlePlaylistCompendium(a,s);break;case"macro":this.handleMacro(s);break;default:return!1}return!0}handleCompendium(e,t){game.packs.get(e).getDocument(t).then((e=>e.sheet.render(!0)))}handleMacroCompendium(e,t){game.packs.get(e).getDocument(t).then((e=>e.execute()))}async handlePlaylistCompendium(e,t){const i=game.packs.get(e),n=t.split(">"),o=n[0],a=n[1],s=(await i.getDocument(o)).sounds.find((e=>e._id===a));AudioHelper.play({src:s.path},{})}handleMacro(e){game.macros.find((t=>t.id===e)).execute()}}class ItemMacroPreRollHandler extends PreRollHandler{prehandleActionEvent(e,t){this.registerKeyPresses(e);const i=t.split("|");if(4!==i.length)return!1;const n=i[0],o=i[1],a=i[2],s=i[3];return"itemMacro"===n&&(this.isRenderItem()?(this.doRenderItem(o,a,s),!0):this._tryExecuteItemMacro(e,o,a,s))}_tryExecuteItemMacro(e,t,i,n){const o=super.getActor(t,i),a=super.getItem(o,n);try{a.executeMacro()}catch(e){return Logger.error("ItemMacro error: ",e),!1}return!0}}class SystemManager{i18n=e=>game.i18n.localize(e);appName;constructor(e){this.appName=e}doGetCategoryManager(){}doGetActionHandler(){}doGetRollHandler(e){}getAvailableRollHandlers(){}doRegisterSettings(e){}async doRegisterDefaultFlags(){}async registerDefaultFlags(){await this.doRegisterDefaultFlags()}async getActionHandler(e){const t=this.doGetActionHandler(this.categoryManager);return this.addActionExtenders(t),t}async getCompendiumActionHandler(e){return new CompendiumActionHandler(this.categoryManager)}addActionExtenders(e){SystemManager.isModuleActive("itemacro")&&e.addFurtherActionHandler(new ItemMacroActionListExtender)}categoryManager;async getCategoryManager(e){const t=this.doGetCategoryManager(e);return await t.init(),t}getRollHandler(){let e=getSetting("rollHandler");"core"===e||SystemManager.isModuleActive(e)||(Logger.error(e,this.i18n("tokenActionHud.handlerNotFound")),e="core",setSetting("rollHandler",e));const t=this.doGetRollHandler(e);return this.addPreHandlers(t),t}addPreHandlers(e){e.addPreRollHandler(new CompendiumMacroPreHandler),SystemManager.isModuleActive("itemacro")&&e.addPreRollHandler(new ItemMacroPreRollHandler)}registerSettings(){const e=this.getAvailableRollHandlers();registerSettings(this.appName,this,e)}static addHandler(e,t){if(SystemManager.isModuleActive(t)){const i=SystemManager.getModuleTitle(t);mergeObject(e,{[t]:i})}}static isModuleActive(e){const t=game.modules.get(e);return t&&t.active}static getModuleTitle(e){return game.modules.get(e)?.title??""}}const n="token-action-hud-core";class CategoryManager{i18n=e=>game.i18n.localize(e);categories=[];user=null;constructor(e){this.user=e}async resetActorFlags(){Logger.debug("Resetting actor flags...");const e=game.actors.filter((e=>e.getFlag(n,"categories")));e&&e.forEach((e=>{Logger.debug(`Resetting flags for actor [${e.id}]`,{actor:e}),e.unsetFlag(n,"categories")})),Logger.debug("Actor flags reset")}async resetUserFlags(){Logger.debug("Resetting user flags..."),await game.user.unsetFlag(n,"categories"),Logger.debug("User flags reset"),this._registerDefaultCategories()}async init(){const e=this.user.getFlag(n,"categories");e?Logger.debug("Retrieved saved categories",{savedCategories:e}):this._registerDefaultCategories()}async _registerDefaultCategories(){const e=this.user.getFlag(n,"default.categories");e&&(await game.user.update({flags:{[n]:{categories:e}}}),Logger.debug("Registered default categories",{defaultCategories:e}))}async submitCategories(e){if(!e)return;const t=game.user.getFlag(n,"categories");t&&await this.deleteCategoriesFlag();const i={};for(const n of e){const e=n.id,o=Object.values(t).find((t=>t.id===e))?.subcategories??null;i[e]={id:n.id,title:n.title,subcategories:o}}const o=i;o&&await this.updateCategoriesFlag(o)}async submitSubcategories(e,t,i){if(!t)return;const o=this.user.getFlag(n,"categories"),a=await getSubcategoryByNestId(Object.values(o),e);if(!a)return;const s={};for(const i of t){s[`${e}_${i.id}`]=i}i&&(a.advancedCategoryOptions=i),a.subcategories=s;const c=o;c&&await this.updateCategoriesFlag(c)}async updateCategoriesFlag(e){await game.user.unsetFlag(n,"categories"),await game.user.setFlag(n,"categories",e)}async deleteCategoriesFlag(){await game.user.update({flags:{[n]:{"-=categories":null}}})}async deleteCategoryFlag(e){const t=e;await game.user.setFlag(n,"categories",{[`-=${t}`]:null})}async deleteSubcategoryFlag(e,t){const i=e,o=`${e}_${t}`;i&&await game.user.setFlag([n],`categories.${i}.subcategories`,{[`-=${o}`]:null})}getSelectedCategoriesAsTagifyEntries(){const e=this.user.getFlag(n,"categories");if(e)return Object.values(e).map((e=>this.toTagifyEntry(e)))}async getSelectedSubcategoriesAsTagifyEntries(e){const t=this.user.getFlag(n,"categories");if(!t)return[];const i=await getSubcategoryByNestId(Object.values(t),e);if(!i.subcategories)return[];const o=Object.values(i.subcategories).map((e=>this.toTagifyEntry(e)));return o||[]}getSubcategoriesAsTagifyEntries(){const e=this.getSystemSubcategoriesAsTagifyEntries(),t=this.getCompendiumSubcategoriesAsTagifyEntries(),i=[];return i.push(...e,...t),i}getSystemSubcategoriesAsTagifyEntries(){return this.user.getFlag(n,"default.subcategories").map((e=>this.toTagifyEntry(e)))}getCompendiumSubcategoriesAsTagifyEntries(){return game.packs.filter((e=>["JournalEntry","Macro","RollTable","Playlist"].includes(e.documentName))).filter((e=>game.user.isGM||!e.private)).map((e=>({id:e.metadata.id.replace(".","-"),value:e.metadata.label,type:"compendium",level:"subcategory"})))}isLinkedCompendium(e){return this.categories.some((t=>t.subcategories?.some((t=>t.compendiumId===e))))}toTagifyEntry(e){return{id:e.id,value:e.title,type:e.type,level:"subcategory"}}}class Action{constructor(){this.id="",this.name="",this.encodedValue="",this.info1="",this.info2="",this.info3="",this.cssClass="",this.icon="",this.img="",this.selected=!0}}export{Action,ActionCategory,ActionHandler,ActionList,ActionListExtender,ActionSubcategory,CategoryManager,CategoryResizer,CompendiumActionHandler,CompendiumMacroPreHandler,GenericActionHandler,ItemMacroActionListExtender,ItemMacroPreRollHandler,Logger,MacroActionHandler,PreRollHandler,RollHandler,SystemManager,TagDialog,TagDialogHelper,TokenActionHud,checkAllow,getSetting,getSubcategories,getSubcategoriesById,getSubcategoryByNestId,initColorSettings,registerHandlebars,registerSettings,setSetting,switchCSS};
