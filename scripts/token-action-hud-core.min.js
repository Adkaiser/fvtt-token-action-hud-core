const e={ID:"token-action-hud-core",NAME:"Token Action HUD"},t="|",i={UTILITY:"utility"},n=["JournalEntry","Macro","RollTable","Playlist"],o=["compendiumEntry","compendiumMacro","compendiumPlaylist","macro"],s={CATEGORY:"category",SUBCATEGORY:"subcategory",ACTION:"action"},a={COMPENDIUM:"compendium",CUSTOM:"custom",SYSTEM:"system",SYSTEM_DERIVED:"system-derived"};class Logger{static info(e,t=!1){t?ui.notifications.info(`Token Action HUD | ${e}`):console.log(`Token Action HUD Info | ${e}`)}static error(e,t=!1){t?ui.notifications.error(`Token Action HUD | ${e}`):console.error(`Token Action HUD Error | ${e}`)}static debug(e,t){if(game.tokenActionHud?game.tokenActionHud.isDebug:Utils.getSetting("debug")){if(!t)return void console.log(`Token Action HUD Debug | ${e}`);const i=Utils.deepClone(t);console.log(`Token Action HUD Debug | ${e}`,i)}}}class Timer{contructor(e){this.milliseconds=e,this.timer=null}async start(){return this.timer&&this.abort(),new Promise((e=>{this.timer=setTimeout(e,this.milliseconds)}))}async abort(){clearTimeout(this.timer),this.timer=null}}class Utils{static checkAllow(e){return e>=this.getSetting("allow")}static deepClone(e,t){return deepClone(e,t)}static getActor(e,t){let i=null;return t&&(i=canvas.tokens.placeables.find((e=>e.id===t))),i?i.actor:game.actors.get(e)}static getImage(e,t=[]){t.push("icons/svg/mystery-man.svg");let i="";return game.tokenActionHud.isDisplayIcons&&(i=e?.img??e?.icon??""),t.includes(i)?"":i}static getItem(e,t){return e.items.get(t)}static getToken(e){return canvas.tokens.placeables.find((t=>t.id===e))}static getControlledTokens(){return game.canvas.tokens.controlled}static getFirstControlledTokens(){return game.canvas.tokens.controlled[0]}static getSetting(t,i=null){let n=i??null;try{n=game.settings.get(e.ID,t)}catch{Logger.debug(`Setting '${t}' not found`)}return n}static async setSetting(t,i){game.settings.settings.get(`${e.ID}.${t}`)?(await game.settings.set(e.ID,t,i),Logger.debug(`Setting '${t}' set to '${i}'`)):Logger.debug(`Setting '${t}' not found`)}static getUserFlag(t){return game.user.getFlag(e.ID,t)}static async setUserFlag(t,i){await game.user.setFlag(e.ID,t,i)}static async unsetUserFlag(t){await game.user.unsetFlag(e.ID,t)}static i18n(e){return game.i18n.localize(e)}static isModuleActive(e){const t=game.modules.get(e);return t&&t.active}static getModuleTitle(e){return game.modules.get(e)?.title??""}static switchCSS(t){const i=[{setting:"compact",file:"tah-compact"},{setting:"foundryVTT",file:"tah-foundry-vtt"},{setting:"dorakoUI",file:"tah-dorako"}];for(const n of i){const i=[`modules/${e.ID}/`,`styles/${n.file}`];n.setting===t?Object.values(document.styleSheets).find((e=>e.href?.includes(i[0])&&e.href?.includes(i[1]))).disabled=!1:Object.values(document.styleSheets).find((e=>e.href?.includes(i[0])&&e.href?.includes(i[1]))).disabled=!0}}static registerHandlebars(){Handlebars.registerHelper("cap",(function(e){return!e||e.length<1?"":e[0].toUpperCase()+e.slice(1)}));const reduceOp=function(e,t){(e=Array.from(e)).pop();const i=e.shift();return e.reduce(t,i)};Handlebars.registerHelper({eq:function(){return reduceOp(arguments,((e,t)=>e===t))},ne:function(){return reduceOp(arguments,((e,t)=>e!==t))},lt:function(){return reduceOp(arguments,((e,t)=>e<t))},gt:function(){return reduceOp(arguments,((e,t)=>e>t))},lte:function(){return reduceOp(arguments,((e,t)=>e<=t))},gte:function(){return reduceOp(arguments,((e,t)=>e>=t))},and:function(){return reduceOp(arguments,((e,t)=>e&&t))},or:function(){return reduceOp(arguments,((e,t)=>e||t))},tf:function(){return reduceOp(arguments,(e=>e))}}),Handlebars.registerHelper("activeText",(function(e){return Utils.getSetting("activeCssAsText")?e.fn(this):e.inverse(this)}))}static getModuleVersionParts(e){if(!e)return void Logger.debug("Module version not retrieved",{trigger:"getModuleVersionParts"});const t=e.split(".");return{major:t[0],minor:t[1],patch:t[2]}}static async checkModuleCompatibility(t){const i=this.getModuleVersionParts(t),n=this.getModuleVersionParts(game.modules.get(e.ID).version);return!(n.major!==i.major||n.minor!==i.minor||i.patch&&n.patch!==i.patch)||(ui.notifications.error(`The installed Token Action Hud system module requires Token Action Hud core module version ${t}.`),!1)}static getSubcategories(e,t={}){if(!e)return;const i=t?.id,n=t?.type;e=Array.isArray(e)?e:Object.values(e);let o=[];for(const s of e)if(i&&s.id!==i||n&&s.type!==n||o.push(s),s.subcategories.length>0){const e=this.getSubcategories(s.subcategories,t);e&&(o=o.concat(e.filter((e=>void 0!==e))))}return o.length>0?o:null}static async getSubcategoryByNestId(e,t={}){const i="string"==typeof t?t:t?.nestId,n=t?.type??"system";if(!i)return;const o=i.split("_");return await async function findSubcategory(e,t){e=Array.isArray(e)?e:Object.values(e);for(const i of e)if(i.id===t[0]){if(1===t.length)return i.type&&i.type!==n?void 0:i;if(0===i.subcategories.length)return;t.shift();const e=await findSubcategory(i.subcategories,t);if(e)return e}}(e,o)}}class MigrationManager{constructor(e){this.systemModuleId=e}async init(){await this._migrateUserFlags()}async _migrateUserFlags(){if("token-action-hud-dnd5e"===!this.systemModuleId)return;const e=Utils.getUserFlag("categories");if(e&&!Array.isArray(e))try{const t=`../../${this.systemModuleId}/scripts/defaults.js`,i=await import(t).then((e=>e.DEFAULTS.subcategories)),n=new Map;i.forEach((e=>{n.set(e.id,e)}));const o=await Utils.deepClone(e);function convertCategories(e){const t=[];for(const i in e){const n={...e[i],nestId:i};n.name=n.title.startsWith("DND5E")?Utils.i18n(n.title.replace("DND5E.Item","ITEM.")):n.title,convertSubcategories(n),t.push(n)}return t;function convertSubcategories(e){if(!e.subcategories)return;if(Array.isArray(e.subcategories))return;const t=[];for(const i in e.subcategories){let o=e.subcategories[i];if(n.has(o.id)?o=n.get(o.id):o.name=o.title,o.nestId=i,convertSubcategories(o),"spells"===o.id){const e=o.nestId.substring(0,o.nestId.lastIndexOf("spells")),i=[{...n.get("at-will-spells"),nestId:`${e}at-will-spells`},{...n.get("innate-spells"),nestId:`${e}innate-spells`},{...n.get("pact-spells"),nestId:`${e}pact-spells`},{...n.get("cantrips"),nestId:`${e}cantrips`},{...n.get("1st-level-spells"),nestId:`${e}1st-level-spells`},{...n.get("2nd-level-spells"),nestId:`${e}2nd-level-spells`},{...n.get("3rd-level-spells"),nestId:`${e}3rd-level-spells`},{...n.get("4th-level-spells"),nestId:`${e}4th-level-spells`},{...n.get("5th-level-spells"),nestId:`${e}5th-level-spells`},{...n.get("6th-level-spells"),nestId:`${e}6th-level-spells`},{...n.get("7th-level-spells"),nestId:`${e}7th-level-spells`},{...n.get("8th-level-spells"),nestId:`${e}8th-level-spells`},{...n.get("9th-level-spells"),nestId:`${e}9th-level-spells`}];t.push(...i)}else if("features"===o.id){const e=o.nestId.substring(0,o.nestId.lastIndexOf("features")),i=[{...n.get("active-features"),nestId:`${e}active-features`},{...n.get("passive-features"),nestId:`${e}passive-features`}];t.push(...i)}else t.push(o)}e.subcategories=t}}Logger.info("Migrating user configuration...",!0);const s=convertCategories(o);await Utils.setUserFlag("categories",s),Logger.info("Successfully migrated user configuration",!0)}catch{await Utils.unsetUserFlag("categories"),Logger.error("Failed to migrate user configuration, reverting to default configuration",!0)}}}class TagDialog extends Dialog{i18n=e=>game.i18n.localize(e);tagify=null;dragSort=null;constructor(e,t){super(t),this.data=e,this.categoryId=null,this.subcategoryId=null}static showDialog(t,i,n,o){this.nestId=t,TagDialog._prepareHook(i);const s=Handlebars.compile(`{{> modules/${e.ID}/templates/tagdialog.hbs}}`);new TagDialog({title:n.title,content:s(n.content),buttons:{accept:{icon:'<i class="fas fa-check"></i>',label:game.i18n.localize("tokenActionHud.accept"),callback:async e=>{const t=TagDialog.tagify.value.map((e=>(e.id=e.id??e.value.slugify({replacement:"-",strict:!0}),{id:e.id,name:e.value,type:e.type,level:e.level,hasDerivedSubcategories:e.hasDerivedSubcategories})));await o(t,e)}},cancel:{icon:'<i class="fas fa-times"></i>',label:game.i18n.localize("tokenActionHud.cancel")}},default:"accept"}).render(!0)}static _prepareHook(e){Hooks.once("renderTagDialog",((t,i,n)=>{i.css("height","auto");const o=i.find('select[id="token-action-hud-index"]');o.length>0&&(o.css("background","#fff"),o.css("color","#000"));const s=i.find('input[class="token-action-hud-taginput"]');if(s.length>0){const a={delimiters:";",maxTags:"Infinity",dropdown:{maxItems:50,classname:"tags-look",enabled:0,closeOnSelect:!1}};function onDragEnd(e){TagDialog.tagify.updateValueByDOMTags()}e.available&&(a.whitelist=e.available),TagDialog.tagify=new Tagify(s[0],a),TagDialog.dragSort=new DragSort(TagDialog.tagify.DOM.scope,{selector:"."+TagDialog.tagify.settings.classNames.tag,callbacks:{dragEnd:onDragEnd}});const r=$(document).find(".tagify");r.css("background","#fff"),r.css("color","#000"),e.selected&&TagDialog.tagify.addTags(e.selected);i.find('button[class="tags--removeAllBtn"]').on("click",TagDialog.tagify.removeAllTags.bind(TagDialog.tagify))}}))}_onKeyDown(e){if("Escape"===e.key&&!e.target.className.includes("tagify"))return e.preventDefault(),e.stopPropagation(),this.close();if("Enter"===e.key&&this.data.default&&!e.target.className.includes("tagify")){e.preventDefault(),e.stopPropagation();const t=this.data.buttons[this.data.default];return this.submit(t)}}}class TagDialogHelper{static async showCategoryDialog(e){const t={available:[]};t.selected=await e.getSelectedCategoriesAsTagifyEntries();const i={title:Utils.i18n("tokenActionHud.tagDialog.categoryDialogTitle"),content:{topLabel:Utils.i18n("tokenActionHud.tagDialog.categoryDialogDescription"),placeholder:Utils.i18n("tokenActionHud.tagDialog.tagPlaceholder"),clearButtonText:Utils.i18n("tokenActionHud.tagDialog.clearButton"),indexExplanationLabel:Utils.i18n("tokenActionHud.pushLabelExplanation")}};TagDialog.showDialog(null,t,i,(async t=>{await e.saveCategories(t),Hooks.callAll("forceUpdateTokenActionHud")}))}static async showSubcategoryDialog(e,t){const{nestId:i,name:n}=t,o={};o.available=await e.getAvailableSubcategoriesAsTagifyEntries(t),o.selected=await e.getSelectedSubcategoriesAsTagifyEntries(t);const s={title:Utils.i18n("tokenActionHud.tagDialog.subcategoryDialogTitle")+` (${n})`,content:{topLabel:Utils.i18n("tokenActionHud.tagDialog.subcategoryDialogDescription"),placeholder:Utils.i18n("tokenActionHud.tagDialog.tagPlaceholder"),clearButtonText:Utils.i18n("tokenActionHud.tagDialog.clearButton"),advancedCategoryOptions:await e.getAdvancedCategoryOptions(t),level:"category"}};TagDialog.showDialog(i,o,s,(async(i,n)=>{i=i.map((e=>(e.id=e.id??e.name.slugify({replacement:"-",strict:!0}),e.type=e.type??"custom",e.hasDerivedSubcategories=e.hasDerivedSubcategories??"false",{id:e.id,name:e.name,type:e.type,hasDerivedSubcategories:e.hasDerivedSubcategories})));const o=parseInt(n.find('input[name="custom-width"]').val()),s=parseInt(n.find('input[name="character-count"]').val());t.advancedCategoryOptions={customWidth:o,characterCount:s},await e.saveSubcategories(i,t),Hooks.callAll("forceUpdateTokenActionHud")}))}static async showActionDialog(e,t,i){const{nestId:n,name:o}=i,s={},a=await t.getAvailableActionsAsTagifyEntries(i),r=await e.getAvailableSubcategoriesAsTagifyEntries(i);s.available=[...a,...r];const c=await t.getSelectedActionsAsTagifyEntries(i),l=await e.getSelectedSubcategoriesAsTagifyEntries(i);s.selected=[...c,...l];const d={title:`${Utils.i18n("tokenActionHud.tagDialog.actionDialogTitle")} (${o})`,content:{topLabel:Utils.i18n("tokenActionHud.tagDialog.actionDialogDescription"),placeholder:Utils.i18n("tokenActionHud.tagDialog.tagPlaceholder"),clearButtonText:Utils.i18n("tokenActionHud.tagDialog.clearButton"),indexExplanationLabel:Utils.i18n("tokenActionHud.blockListLabel"),advancedCategoryOptions:await e.getAdvancedCategoryOptions(i),level:"subcategory"}};TagDialog.showDialog(n,s,d,(async(n,o)=>{const s=[],a=[];for(const e of n)switch(e.level){case"subcategory":s.push(e);break;case"action":a.push(e)}const r=parseInt(o.find('input[name="character-count"]').val()),c=parseInt(o.find('input[name="custom-width"]').val()),l=o.find('input[name="show-name"]').prop("checked");i.advancedCategoryOptions={characterCount:r,customWidth:c,showTitle:l},await e.saveSubcategories(s,i),await t.saveActions(a,i),Hooks.callAll("forceUpdateTokenActionHud")}))}}class CategoryResizer{static async resizeCategory(e,t,i){if(!t)return;const n=t.querySelectorAll(".tah-actions");if(0===n.length)return;const o=t.querySelector(".tah-subcategories"),s=t.id.replace("tah-category-",""),a=(await e.getAdvancedCategoryOptions(s))?.customWidth,r=o.getBoundingClientRect(),c=r.height,l=r.top,d=canvas.screenDimensions[1],g=("down"===i?document.querySelector("#ui-bottom"):document.querySelector("#ui-top")).offsetHeight,u="down"===i?d-l-g-10:c+l-g-10,h=u<100?100:u;let m=500;if(a)m=a;else{const e=document.querySelector("#ui-right"),t=canvas.screenDimensions[0],i=getComputedStyle(o),s=Math.ceil(parseFloat(i.paddingLeft)||0)+Math.ceil(parseFloat(i.paddingRight)||0),a=r.left,c=e.clientWidth,l=(c>0?t-c:t)-10-a;let d=0,g=0;for(const e of n){const t=e.querySelectorAll(".tah-action");if(t.length>0){let e=0;t.forEach(((t,i)=>{const n=t.getBoundingClientRect(),o=0===i?n.left-a:0,s=Math.ceil(parseFloat(n.width)+1||0);e+=s+o})),e>g&&(g=e,d=t.length)}}g+=5*d-5,g+=s;const u=g/d,h=5;let p=d<h?d:h;const f=Math.floor(l/u),y=Math.ceil(Math.sqrt(d));y>p&&y<=f&&(p=y),m=u*p,m>l&&(m=l),m<200&&(m=200)}requestAnimationFrame((()=>{Object.assign(o.style,{maxHeight:`${Math.ceil(h)}px`,width:`${m}px`})}))}}class TokenActionHud extends Application{hoveredCategoryId="";defaultHeight=200;defaultWidth=20;defaultLeftPos=150;defaultTopPos=80;defaultScale=1;refreshTimeout=null;rendering=!1;tokens=null;constructor(e){super(),this.systemManager=e,this.direction="down",this.isAlwaysShow=!1,this.isClickOpen=!1,this.isCollapsed=!1,this.isDisplayIcons=!1,this.isDraggable=!1,this.isEnabled=!1,this.isUnlocked=!1}async init(){this.direction=Utils.getSetting("direction"),this.isAlwaysShow=Utils.getSetting("alwaysShowHud"),this.isClickOpen=Utils.getSetting("clickOpenCategory"),this.isCollapsed=Utils.getUserFlag("isCollapsed"),this.isDebug=Utils.getSetting("debug"),this.isDisplayIcons=Utils.getSetting("displayIcons"),this.isDraggable=Utils.getSetting("drag"),this.isEnabled=this.isHudEnabled(),this.isUnlocked=Utils.getUserFlag("isUnlocked"),await this.systemManager.registerDefaultFlags(),this.categoryManager=await this.systemManager.getCategoryManager(),this.actionHandler=await this.systemManager.getActionHandler(this.categoryManager),this.rollHandler=this.systemManager.getRollHandler()}updateSettings(){Logger.debug("Updating settings..."),this.updateRollHandler(),this.direction=Utils.getSetting("direction"),this.isAlwaysShow=Utils.getSetting("alwaysShowHud"),this.isClickOpen=Utils.getSetting("clickOpenCategory"),this.isDebug=Utils.getSetting("debug"),this.isDisplayIcons=Utils.getSetting("displayIcons"),this.isDraggable=Utils.getSetting("drag"),this.isEnabled=this.isHudEnabled(),this.actionHandler.displayIcons=Utils.getSetting("displayIcons"),Logger.debug("Settings updated");this.update({trigger:{type:"method",name:"TokenActionHud#updateSettings"}})}updateRollHandler(){this.rollHandler=this.systemManager.getRollHandler()}setTokens(e){this.tokens=e}static get defaultOptions(){return mergeObject(super.defaultOptions,{template:`/modules/${e.ID}/templates/template.hbs`,id:"token-action-hud",classes:[],width:this.defaultWidth,height:this.defaultHeight,left:this.defaultLeftPos,top:this.defaultTopPos,scale:this.defaultScale,background:"none",popOut:!1,minimizable:!1,resizable:!1,title:"token-action-hud",dragDrop:[],tabs:[],scrollY:[]})}getScale(){const e=parseFloat(Utils.getSetting("scale"));return e<.5?.5:e>2?2:e}getData(e={}){const t=super.getData();return t.actions=this.actionList,t.id="token-action-hud",t.scale=this.getScale(),t.background=Utils.getSetting("background")??"#00000000",Logger.debug("Application data",{data:t}),t}activateListeners(e){const t={actions:e.find(".tah-action"),buttons:e.find("#tah-buttons"),categories:e.find(".tah-category"),categoriesSection:e.find("#tah-categories"),editCategoriesButton:e.find("#tah-edit-categories"),subcategories:e.find(".tah-subcategory"),subtitles:e.find(".tah-subtitle"),titleButtons:e.find(".tah-category-button"),collapseHudButton:e.find("#tah-collapse-hud"),expandHudButton:e.find("#tah-expand-hud"),unlockButton:e.find("#tah-unlock"),lockButton:e.find("#tah-lock")};this._bindCategoryEvents(t),this._bindActionEvents(t),this._bindEditCategoriesButton(t),this._bindLockUnlockButtons(t),this._bindCollapseExpandButtons(t)}_bindCategoryEvents(e){const closeCategory=e=>{if(game.tokenActionHud.rendering)return;const t=this.isClickOpen?e.currentTarget.parentElement:e.currentTarget;t.classList.remove("hover");const i=t.id;this.clearHoveredCategory(i)},openCategory=e=>{const t=this.isClickOpen?e.currentTarget.parentElement:e.currentTarget;t.classList.add("hover");const i=t.id;this.setHoveredCategory(i),CategoryResizer.resizeCategory(this.categoryManager,t,this.direction)},toggleCategory=t=>{if(t.currentTarget.parentElement.classList.contains("hover"))closeCategory(t);else{for(const t of e.categories)t.classList.remove("hover");openCategory(t)}t.currentTarget.blur()};if(""!==this.hoveredCategoryId){const e=`#${this.hoveredCategoryId}`,t=document.querySelector(e);CategoryResizer.resizeCategory(this.categoryManager,t,this.direction)}e.titleButtons.on("click",(e=>{this.bringToTop(),e.currentTarget.blur()})),this.isClickOpen?e.titleButtons.on("click",toggleCategory):(e.categories.get().forEach((e=>{e.addEventListener("touchstart",toggleCategory,{passive:!0})})),e.categories.hover(openCategory,closeCategory)),e.titleButtons.on("mousedown",(e=>this.dragEvent(e))),e.titleButtons.get().forEach((e=>{e.addEventListener("touchstart",(e=>this.dragEvent(e)),{passive:!0})}));const openSubcategoryDialog=e=>{const t=e.currentTarget;if(0===t.value.length)return;const i=t.value,n=t.innerText??t.outerText,o=t?.dataset?.type;TagDialogHelper.showSubcategoryDialog(this.categoryManager,{nestId:i,name:n,type:o})};e.titleButtons.on("contextmenu",(e=>{this.isUnlocked&&openSubcategoryDialog(e)}))}_bindActionEvents(e){const handleAction=e=>{let t=e.target;"BUTTON"!==t.tagName&&(t=e.currentTarget.children[0]);const i=t.value;try{this.rollHandler.handleActionEvent(e,i),t.blur()}catch(t){Logger.error(e)}},openActionDialog=e=>{const{id:t,innerText:i,outerText:n,dataset:o}=e.target;if(!t)return;const s=t,a=i||n,r=o?.type,c=o?.hasDerivedSubcategories;TagDialogHelper.showActionDialog(this.categoryManager,this.actionHandler,{nestId:s,name:a,type:r,hasDerivedSubcategories:c})};e.subtitles.on("click contextmenu",(e=>{this.isUnlocked&&openActionDialog(e)})),e.actions.on("click contextmenu",(e=>{e.preventDefault(),handleAction(e)}))}_bindEditCategoriesButton(e){e.editCategoriesButton.on("click",(e=>{e.preventDefault(),e=e||window.event,TagDialogHelper.showCategoryDialog(this.categoryManager)}))}_bindLockUnlockButtons(e){const unlockHud=async(t=null)=>{t&&(t.preventDefault(),t=t||window.event);const i=t?.target||e.unlockButton;$(i).addClass("tah-hidden"),e.lockButton.removeClass("tah-hidden"),e.editCategoriesButton.removeClass("tah-hidden"),e.categoriesSection.addClass("tah-unlocked"),e.categories.removeClass("tah-hidden"),e.subcategories.removeClass("tah-hidden"),e.subtitles.removeClass("disable-edit"),e.subtitles.removeClass("tah-hidden"),e.titleButtons.removeClass("disable-edit"),this.isUnlocked||(await Utils.setUserFlag("isUnlocked",!0),this.isUnlocked=!0)},lockHud=async(t=null)=>{t&&(t.preventDefault(),t=t||window.event);const i=t?.target||e.lockButton;$(i).addClass("tah-hidden"),e.unlockButton.removeClass("tah-hidden"),e.editCategoriesButton.addClass("tah-hidden"),e.categoriesSection.removeClass("tah-unlocked");for(const t of e.categories){t.getElementsByClassName("tah-action").length>0||t.classList.add("tah-hidden")}for(const t of e.subcategories){t.getElementsByClassName("tah-action").length>0||t.classList.add("tah-hidden")}for(const t of e.subtitles)"false"===t.parentElement.dataset.showTitle&&t.classList.add("tah-hidden");e.titleButtons.addClass("disable-edit"),e.subtitles.addClass("disable-edit"),this.isUnlocked&&(await Utils.setUserFlag("isUnlocked",!1),this.isUnlocked=!1)};this.isUnlocked?unlockHud():lockHud(),e.unlockButton.on("click",(e=>unlockHud(e))),e.lockButton.on("click",(e=>lockHud(e)))}_bindCollapseExpandButtons(e){const collapseHud=(t=null)=>{t&&(t.preventDefault(),t=t||window.event);const i=t?.target||e.collapseHudButton;$(i).addClass("tah-hidden"),e.expandHudButton.removeClass("tah-hidden"),e.categoriesSection.addClass("tah-hidden"),e.buttons.addClass("tah-hidden"),this.isCollapsed||(Utils.setUserFlag("isCollapsed",!0),this.isCollapsed=!0)},expandHud=t=>{t.preventDefault(),t=t||window.event,$(t.target).addClass("tah-hidden"),e.collapseHudButton.removeClass("tah-hidden"),e.categoriesSection.removeClass("tah-hidden"),e.buttons.removeClass("tah-hidden"),this.isCollapsed&&(Utils.setUserFlag("isCollapsed",!1),this.isCollapsed=!1)};this.isCollapsed&&collapseHud(),e.collapseHudButton.on("click",(e=>collapseHud(e))),e.expandHudButton.on("click",(e=>expandHud(e))),e.expandHudButton.on("mousedown",(e=>this.dragEvent(e))),e.expandHudButton.get(0).addEventListener("touchstart",(e=>this.dragEvent(e)),{passive:!0})}dragEvent(e){if(!this.isDraggable)return;const t=document.getElementById("token-action-hud"),i=e.clientX??e.changedTouches[0].clientX,n=e.clientY??e.changedTouches[0].clientY;let o=0,s=0,a=i,r=n;const c=t.offsetTop,l=t.offsetLeft;let d=c,g=l;const mouseMoveEvent=e=>{const i=e.clientX??e.changedTouches[0].clientX,n=e.clientY??e.changedTouches[0].clientY;o=a-i,s=r-n,a=i,r=n,o===a&&s===r||(d-=s,g-=o,requestAnimationFrame((()=>{Object.assign(t.style,{left:`${g}px`,position:"fixed",top:`${d}px`})})))},mouseUpEvent=()=>{document.onmousemove=null,t.ontouchmove=null,document.onmouseup=null,t.ontouchend=null,d===c&&g===l||(Utils.setUserFlag("position",{top:d,left:g}),Logger.debug(`Set position to x: ${d}px, y: ${g}px`))};document.onmousemove=mouseMoveEvent,t.ontouchmove=mouseMoveEvent,document.onmouseup=mouseUpEvent,t.ontouchend=mouseUpEvent}applySettings(){"up"===Utils.getSetting("direction")&&($(document).find(".tah-subcategories-wrapper").removeClass("expand-down"),$(document).find(".tah-subcategories-wrapper").addClass("expand-up"),$(document).find("#tah-character-name").addClass("tah-hidden"))}setPosition(){if(!this.actionList)return;const e=$(document).find("#tah-character-name");e.length>0&&e.css("top",-e[0].getBoundingClientRect().height),canvas?.tokens?.placeables.find((e=>e.id===this.actionList?.tokenId)),this.setPositionFromFlag(),this.restoreHoveredCategoryState(),this.rendering=!1}setPositionFromFlag(){const e=Utils.getUserFlag("position");if(!e)return;const t=this.defaultLeftPos,i=this.defaultTopPos;return new Promise((n=>{!function check(){const o=document.getElementById("token-action-hud");o?(o.style.bottom=null,o.style.top=e.top<5||e.top>window.innerHeight+5?i+"px":e.top+"px",o.style.left=e.left<5||e.left>window.innerWidth+5?t+"px":e.left+"px",o.style.position="fixed",n()):setTimeout(check,30)}()}))}setPositionFromToken(e){return new Promise((t=>{!function check(e){const i=$("#token-action-hud");i?(i.css("bottom",null),i.css("left",e.worldTransform.tx+(e.width*canvas.dimensions.size+55)*canvas.scene._viewPosition.scale+"px"),i.css("top",e.worldTransform.ty+0+"px"),i.css("position","fixed"),t()):setTimeout(check,30)}(e)}))}async resetPosition(){Logger.debug("Resetting position..."),await Utils.setUserFlag("position",{top:this.defaultTopPos,left:this.defaultLeftPos}),Logger.debug(`Position reset to x: ${this.defaultTopPos}px, y: ${this.defaultLeftPos}px`)}setHoveredCategory(e){this.hoveredCategoryId=e}clearHoveredCategory(e){this.hoveredCategoryId===e&&(this.hoveredCategoryId="")}restoreHoveredCategoryState(){if(""===this.hoveredCategoryId)return;const e=`#${this.hoveredCategoryId}`,t=$(e);if(t[0])if(this.isClickOpen){t.find(".tah-category-button")[0].click()}else t.mouseenter()}async copy(e,t){await this.categoryManager.copyUserFlags(e,t)?Logger.info("HUD copied",!0):Logger.info("Copy HUD failed",!0)}async reset(){await this.resetUserFlags(),this.resetPosition(),Logger.info("HUD reset",!0)}async resetActorFlags(){await this.categoryManager.resetActorFlags();this.update({trigger:{type:"method",name:"TokenActionHud.resetActorFlags"}})}async resetUserFlags(){await this.categoryManager.resetUserFlags(),this.categoryManager.resetCategoryManager(),this.actionHandler.resetActionHandler();this.update({trigger:{type:"method",name:"TokenActionHud.resetUserFlags"}})}update(e=null){this._updateHud(e)}async _updateHud(e){Logger.debug("Updating hud...",e);const t=Utils.getControlledTokens(),i=this._getCharacter(t),n=t.length>1&&!i;return(i||n)&&this.isEnabled?(this.actionList=await this.actionHandler.buildActionList(i),0===this.actionList.length?(this.close(),void Logger.debug("Hud update aborted as action list empty")):(this.rendering=!0,this.render(!0),void Logger.debug("Hud updated"))):(this.close(),void Logger.debug("Hud update aborted as no character(s) found or hud is disabled"))}isValidTokenChange(e,t=null){return!t?.actorData?.flags&&(this.isAlwaysShow?this.isRelevantToken(e)||e.actorId===game.user.character?.id:this.isRelevantToken(e))}isRelevantToken(e){const t=Utils.getControlledTokens();return t?.some((t=>t.id===e.id))||0===t?.length&&canvas?.tokens?.placeables?.some((e=>e.id===this.actionList?.tokenId))}isValidActorOrItemUpdate(e,t){return t?.flags?(Logger.debug("Flags set, do not update hud",{actor:e,data:t}),!1):e?e?this.actionList&&e.id===this.actionList.actorId?(Logger.debug("Same actor, update hud",{actor:e,data:t}),!0):(Logger.debug("Different actor, do not update hud",{actor:e,data:t}),!1):(Logger.debug("No actor, update hud",{data:t}),!0):void 0}isHudEnabled(){const e=game.user.role,t=game.user.isGM;return!!Utils.getSetting("enable")&&(!!t||Utils.checkAllow(e))}isLinkedCompendium(e){return Logger.debug("Compendium hook triggered, checking if compendium is linked..."),this.categoryManager.isLinkedCompendium(e)}_getCharacter(e=[]){if(e.length>1)return null;const t={token:null,actor:null};if(1===e.length){const i=e[0],n=i.actor;if(!this._isValidCharacter(i))return null;t.token=i,t.actor=n}else 0===e.length&&game.user.character&&this.isAlwaysShow&&(t.actor=game.user.character,t.token=canvas.tokens.placeables.find((e=>e.actor?.id===t.actor.id)));return t.actor?(t.id=t.token?.id??t.actor.id,t.name=t.token?.name??t.actor.name,t):null}_isValidCharacter(e=""){const t=e.actor,i=game.user;return game.user.isGM||t?.testUserPermission(i,"OWNER")}}let r,c=!1;const l=new Timer(20);function onChangeFunction(e){game.tokenActionHud&&game.tokenActionHud.updateSettings()}Hooks.on("tokenActionHudSystemReady",(async t=>{if(!await Utils.checkModuleCompatibility(t.api.requiredCoreModuleVersion))return;r=new t.api.SystemManager(e.ID),r.registerSettings();const i=new MigrationManager(t.id);await i.init(),Utils.switchCSS(Utils.getSetting("style")),Utils.registerHandlebars(),loadTemplates([`modules/${e.ID}/templates/category.hbs`,`modules/${e.ID}/templates/subcategory.hbs`,`modules/${e.ID}/templates/action.hbs`,`modules/${e.ID}/templates/tagdialog.hbs`]),Hooks.callAll("tokenActionHudCoreReady")})),Hooks.on("canvasReady",(async()=>{Hooks.on("tokenActionHudCoreReady",(async()=>{if(game.user.isGM&&!game.modules.get("lib-themer")?.active&&!game.modules.get("color-picker")?.active&&!game.modules.get("colorsettings")?.active){!1===Utils.getSetting("startup")&&(ui.notifications.notify("Token Action Hud: To set colors within this module's settings, install and enable one of the following 'Color Picker', 'Color Settings' or 'libThemer' modules."),Utils.setSetting("startup",!0))}game.tokenActionHud||(game.tokenActionHud=new TokenActionHud(r),await game.tokenActionHud.init()),game.tokenActionHud.setTokens(canvas.tokens),Hooks.on("controlToken",(async(t,i)=>{c&&await l.abort(),c=!0,await l.start(),c=!1;const n=game.tokenActionHud.actionHandler.actorId;Utils.getControlledTokens()?.length??0?n!==t.document.actor.id?game.tokenActionHud.update(e):game.tokenActionHud.render(!0):game.user.character?n!==game.user.character?.id?game.tokenActionHud.update(e):game.tokenActionHud.rendered||game.tokenActionHud.render(!0):game.tokenActionHud.rendered&&game.tokenActionHud.close()})),Hooks.on("updateToken",((e,t,i)=>{if(!Object.hasOwn(i,"y")&&!Object.hasOwn("diff","x")&&game.tokenActionHud.isValidTokenChange(e,t)){const n={trigger:{type:"hook",name:"updateToken",data:[e,t,i]}};game.tokenActionHud.update(n)}})),Hooks.on("deleteToken",((e,t,i,n)=>{if(game.tokenActionHud.isValidTokenChange(t)){const o={trigger:{type:"hook",name:"deleteToken",data:[e,t,i,n]}};game.tokenActionHud.update(o)}})),Hooks.on("updateActor",((e,t)=>{if(game.tokenActionHud.isValidActorOrItemUpdate(e,t)){const i={trigger:{type:"hook",name:"updateActor",data:[e,t]}};game.tokenActionHud.update(i)}})),Hooks.on("deleteActor",((e,t)=>{if(game.tokenActionHud.isValidActorOrItemUpdate(e,t)){const i={trigger:{type:"hook",name:"deleteActor",data:[e,t]}};game.tokenActionHud.update(i)}})),Hooks.on("deleteItem",(e=>{const t=e.actor;if(game.tokenActionHud.isValidActorOrItemUpdate(t)){const t={trigger:{type:"hook",name:"deleteItem",data:[e]}};game.tokenActionHud.update(t)}})),Hooks.on("createItem",(e=>{const t=e.actor;if(game.tokenActionHud.isValidActorOrItemUpdate(t)){const t={trigger:{type:"hook",name:"createItem",data:[e]}};game.tokenActionHud.update(t)}})),Hooks.on("updateItem",(e=>{const t=e.actor;if(game.tokenActionHud.isValidActorOrItemUpdate(t)){const t={trigger:{type:"hook",name:"updateItem",data:[e]}};game.tokenActionHud.update(t)}})),Hooks.on("renderTokenActionHud",(()=>{game.tokenActionHud.applySettings()})),Hooks.on("renderCompendium",((e,t)=>{const i=e?.metadata;if(game.tokenActionHud.isLinkedCompendium(`${i?.package}.${i?.name}`)){const i={trigger:{type:"hook",name:"renderCompendium",data:[e,t]}};game.tokenActionHud.update(i)}})),Hooks.on("deleteCompendium",((e,t)=>{const i=e?.metadata;if(game.tokenActionHud.isLinkedCompendium(`${i?.package}.${i?.name}`)){const i={trigger:{type:"hook",name:"deleteCompendium",data:[e,t]}};game.tokenActionHud.update(i)}})),Hooks.on("createCombat",(e=>{const t={trigger:{type:"hook",name:"createCombat",data:[e]}};game.tokenActionHud.update(t)})),Hooks.on("deleteCombat",(e=>{const t={trigger:{type:"hook",name:"deleteCombat",data:[e]}};game.tokenActionHud.update(t)})),Hooks.on("updateCombat",(e=>{const t={trigger:{type:"hook",name:"updateCombat",data:[e]}};game.tokenActionHud.update(t)})),Hooks.on("updateCombatant",((e,t)=>{const i={trigger:{type:"hook",name:"updateCombatant",data:[e,t]}};game.tokenActionHud.update(i)})),Hooks.on("forceUpdateTokenActionHud",(()=>{game.tokenActionHud.update({trigger:{type:"hook",name:"forceUpdateTokenActionHud"}})})),Hooks.on("createActiveEffect",(()=>{game.tokenActionHud.update({trigger:{type:"hook",name:"createActiveEffect"}})})),Hooks.on("deleteActiveEffect",(()=>{game.tokenActionHud.update({trigger:{type:"hook",name:"deleteActiveEffect"}})}));const e={trigger:{type:"hook",name:"canvasReady"}};game.tokenActionHud.update(e)}))}));const registerSettings=function(t,i){game.settings.register(e.ID,"startup",{name:"One-Time Startup Prompt",scope:"world",config:!1,type:Boolean,default:!1}),game.settings.register(e.ID,"rollHandler",{name:Utils.i18n("tokenActionHud.settings.rollHandler.name"),hint:Utils.i18n("tokenActionHud.settings.rollHandler.hint"),scope:"world",config:!0,type:String,choices:i,default:"core",onChange:e=>{onChangeFunction()}}),game.settings.register(e.ID,"style",{name:Utils.i18n("tokenActionHud.settings.style.name"),hint:Utils.i18n("tokenActionHud.settings.style.hint"),scope:"client",config:!0,type:String,default:"foundryVTT",choices:{compact:"Compact",foundryVTT:"Foundry VTT",dorakoUI:"Dorako UI"},onChange:e=>{Utils.switchCSS(e)}}),game.settings.register(e.ID,"direction",{name:Utils.i18n("tokenActionHud.settings.direction.name"),hint:Utils.i18n("tokenActionHud.settings.direction.hint"),scope:"client",config:!0,type:String,default:"down",choices:{up:Utils.i18n("tokenActionHud.settings.direction.choices.up"),down:Utils.i18n("tokenActionHud.settings.direction.choices.down")},onChange:e=>{onChangeFunction()}}),game.settings.register(e.ID,"scale",{name:Utils.i18n("tokenActionHud.settings.scale.name"),hint:Utils.i18n("tokenActionHud.settings.scale.hint"),scope:"client",config:!0,type:Number,range:{min:.5,max:2,step:.05},default:1,onChange:e=>{onChangeFunction()}}),game.settings.register(e.ID,"drag",{name:Utils.i18n("tokenActionHud.settings.drag.name"),hint:Utils.i18n("tokenActionHud.settings.drag.hint"),scope:"client",config:!0,type:Boolean,default:!0,onChange:e=>{onChangeFunction()}}),function initColorSettings(){let t=null;game.modules.get("lib-themer")?.active?t="lib-themer":game.modules.get("color-picker")?.active?t="color-picker":game.modules.get("colorsettings")?.active&&(t="colorsettings");switch(t){case"lib-themer":Hooks.once("lib-themer.Ready",(t=>{t.register({id:e.ID,title:game.modules.get(e.ID).title,"--tah-background":{name:"tokenActionHud.settings.background.name",hint:"tokenActionHud.settings.background.hint",type:"color",default:"#00000000"},"--tah-button-background":{name:"tokenActionHud.settings.buttonBackgroundColor.name",hint:"tokenActionHud.settings.buttonBackgroundColor.hint",type:"color",default:"#00000080",colors:{buttons:!0}}})}));break;case"color-picker":"object"==typeof ColorPicker?registerColorSettings(t):Hooks.once("colorPickerReady",(()=>{registerColorSettings(t)}));break;case"colorsettings":Hooks.once("ready",(()=>{try{window.Ardittristan.ColorSetting.tester,registerColorSettings(t)}catch{}}))}}(),game.settings.register(e.ID,"enable",{name:Utils.i18n("tokenActionHud.settings.enable.name"),hint:Utils.i18n("tokenActionHud.settings.enable.hint"),scope:"client",config:!0,type:Boolean,default:!0,onChange:e=>{onChangeFunction()}}),game.settings.register(e.ID,"allow",{name:Utils.i18n("tokenActionHud.settings.allow.name"),hint:Utils.i18n("tokenActionHud.settings.allow.hint"),scope:"world",config:!0,type:String,choices:{4:Utils.i18n("tokenActionHud.settings.allow.choices.4"),3:Utils.i18n("tokenActionHud.settings.allow.choices.3"),2:Utils.i18n("tokenActionHud.settings.allow.choices.2"),1:Utils.i18n("tokenActionHud.settings.allow.choices.1")},default:1,requiresReload:!0}),game.settings.register(e.ID,"alwaysShowHud",{name:Utils.i18n("tokenActionHud.settings.alwaysShowHud.name"),hint:Utils.i18n("tokenActionHud.settings.alwaysShowHud.hint"),scope:"client",config:!0,type:Boolean,default:!0,onChange:e=>{onChangeFunction()}}),game.settings.register(e.ID,"displayCharacterName",{name:Utils.i18n("tokenActionHud.settings.displayCharacterName.name"),hint:Utils.i18n("tokenActionHud.settings.displayCharacterName.hint"),scope:"client",config:!0,type:Boolean,default:!0,onChange:e=>{onChangeFunction()}}),game.settings.register(e.ID,"displayIcons",{name:Utils.i18n("tokenActionHud.settings.displayIcons.name"),hint:Utils.i18n("tokenActionHud.settings.displayIcons.hint"),scope:"client",config:!0,type:Boolean,default:!0,onChange:e=>{onChangeFunction()}}),game.settings.register(e.ID,"clickOpenCategory",{name:Utils.i18n("tokenActionHud.settings.clickOpenCategory.name"),hint:Utils.i18n("tokenActionHud.settings.clickOpenCategory.hint"),scope:"client",config:!0,type:Boolean,default:!1,onChange:e=>{onChangeFunction()}}),game.settings.register(e.ID,"renderItemOnRightClick",{name:Utils.i18n("tokenActionHud.settings.renderItemOnRightClick.name"),hint:Utils.i18n("tokenActionHud.settings.renderItemOnRightClick.hint"),scope:"client",config:!0,type:Boolean,default:!0,onChange:e=>{onChangeFunction()}}),game.modules.get("itemacro")?.active&&game.settings.register(e.ID,"itemMacro",{name:Utils.i18n("tokenActionHud.settings.itemMacro.name"),hint:Utils.i18n("tokenActionHud.settings.itemMacro.hint"),scope:"client",config:!0,type:String,choices:{both:Utils.i18n("tokenActionHud.settings.itemMacro.choices.both"),itemMacro:Utils.i18n("tokenActionHud.settings.itemMacro.choices.itemMacro"),original:Utils.i18n("tokenActionHud.settings.itemMacro.choices.original")},default:"both",onChange:e=>{onChangeFunction()}}),game.settings.register(e.ID,"activeCssAsText",{name:Utils.i18n("tokenActionHud.settings.activeCssAsText.name"),hint:Utils.i18n("tokenActionHud.settings.activeCssAsText.hint"),scope:"client",config:!0,type:Boolean,default:!1,onChange:e=>{onChangeFunction()}}),game.settings.register(e.ID,"debug",{name:Utils.i18n("tokenActionHud.settings.debug.name"),hint:Utils.i18n("tokenActionHud.settings.debug.hint"),scope:"client",config:!0,type:Boolean,default:!1,onChange:e=>{onChangeFunction()}}),game.settings.register(e.ID,"reset",{name:Utils.i18n("tokenActionHud.settings.reset.name"),hint:Utils.i18n("tokenActionHud.settings.reset.hint"),scope:"client",config:!0,type:Boolean,default:!1,onChange:e=>{e&&(Utils.setSetting("reset",!1),game.tokenActionHud.reset())}}),t.doRegisterSettings(onChangeFunction),Logger.debug("Available roll handlers",{rollHandlers:i})};function registerColorSettings(t){const i={key:"background",name:Utils.i18n("tokenActionHud.settings.background.name"),hint:Utils.i18n("tokenActionHud.settings.background.hint"),scope:"client",restricted:!1,default:"#00000000",onChange:e=>{document.querySelector(":root").style.setProperty("--tah-background",e),onChangeFunction()}},n={key:"buttonBackgroundColor",name:Utils.i18n("tokenActionHud.settings.buttonBackgroundColor.name"),hint:Utils.i18n("tokenActionHud.settings.buttonBackgroundColor.hint"),scope:"client",restricted:!0,default:"#00000080",onChange:e=>{document.querySelector(":root").style.setProperty("--tah-button-background",e),onChangeFunction()}},o={key:"buttonBorderColor",name:Utils.i18n("tokenActionHud.settings.buttonBorderColor.name"),hint:Utils.i18n("tokenActionHud.settings.buttonBorderColor.hint"),scope:"client",restricted:!0,default:"#000000ff",onChange:e=>{document.querySelector(":root").style.setProperty("--tah-button-outline",e),onChangeFunction()}};if("color-picker"===t){const t={format:"hexa",alphaChannel:!0};ColorPicker.register(e.ID,i.key,{name:i.name,hint:i.hint,scope:i.scope,restricted:i.restricted,default:i.default,onChange:i.onChange},t),ColorPicker.register(e.ID,n.key,{name:n.name,hint:n.hint,scope:n.scope,restricted:n.restricted,default:n.default,onChange:n.onChange},t),ColorPicker.register(e.ID,o.key,{name:o.name,hint:o.hint,scope:o.scope,restricted:o.restricted,default:o.default,onChange:o.onChange},t)}else"colorsettings"===t&&(new window.Ardittristan.ColorSetting(e.ID,i.key,{name:i.name,hint:i.hint,scope:i.scope,restricted:i.restricted,defaultColor:i.default,onChange:i.onChange,insertAfter:`${e.ID}.scale`}),new window.Ardittristan.ColorSetting(e.ID,n.key,{name:n.name,hint:n.hint,scope:n.scope,restricted:n.restricted,defaultColor:n.default,onChange:n.onChange,insertAfter:`${e.ID}.${i.key}`}),new window.Ardittristan.ColorSetting(e.ID,o.key,{name:o.name,hint:o.hint,scope:o.scope,restricted:o.restricted,defaultColor:o.default,onChange:o.onChange,insertAfter:`${e.ID}.${n.key}`}));document.querySelector(":root").style.setProperty("--tah-background",Utils.getSetting("background")??"#00000000"),document.querySelector(":root").style.setProperty("--tah-button-background",Utils.getSetting("buttonBackgroundColor")??"#000000b3"),document.querySelector(":root").style.setProperty("--tah-button-outline",Utils.getSetting("buttonBorderColor")??"#000000ff")}class GenericActionHandler{actionHandler;constructor(e){this.actionHandler=e}buildGenericActions(e){this._buildConditions(e),this._buildUtilities(e)}_buildConditions(e){}_buildUtilities(e){if(e)return this._buildSingleTokenUtilities(e);this._buildMultipleTokenUtilities()}_buildSingleTokenUtilities(e){const t=e.actor?.id,n=e.token?.id;if(!n)return;const o=[],s="toggleCombat",r=canvas.tokens.placeables.find((e=>e.id===n)).inCombat?Utils.i18n("tokenActionHud.removeFromCombat"):Utils.i18n("tokenActionHud.addToCombat"),c=[i.UTILITY,t,n,s].join("|"),l={id:s,name:r,encodedValue:c,selected:!0};if(o.push(l),game.user.isGM){const e="toggleVisibility",s=canvas.tokens.placeables.find((e=>e.id===n)).document.hidden?Utils.i18n("tokenActionHud.makeVisible"):Utils.i18n("tokenActionHud.makeInvisible"),a=[i.UTILITY,t,n,e].join("|"),r={id:e,name:s,encodedValue:a,selected:!0};o.push(r)}const d={id:"token",type:a.SYSTEM};this.actionHandler.addActionsToActionList(o,d)}_buildMultipleTokenUtilities(){const e="multi",t="multi",n=Utils.getControlledTokens(),o=[],s="toggleCombat",r=n.every((e=>e.inCombat))?Utils.i18n("tokenActionHud.removeFromCombat"):Utils.i18n("tokenActionHud.addToCombat"),c=[i.UTILITY,e,t,s].join("|"),l={id:s,name:r,encodedValue:c};if(o.push(l),game.user.isGM){const s="toggleVisibility",a=n.every((e=>!e.document.hidden))?Utils.i18n("tokenActionHud.makeVisible"):Utils.i18n("tokenActionHud.makeInvisible"),r=[i.UTILITY,e,t,s].join("|"),c={id:s,name:a,encodedValue:r};o.push(c)}const d={id:"token",type:a.SYSTEM};this.actionHandler.addActionsToActionList(o,d)}}class CompendiumActionHandler{actionHandler;constructor(e){this.actionHandler=e,this.categoryManager=e.categoryManager}async buildCompendiumActions(){const e="compendium",t=this.categoryManager.getFlattenedSubcategories({type:e}).flatMap((e=>e.id));if(!t)return;const i=game.packs.filter((e=>n.includes(e.documentName))).filter((e=>game.user.isGM||!e.private)).map((e=>e.metadata.id));for(const n of i){const i={id:n.replace(".","-"),type:e};if(t.includes(n.replace(".","-"))){const e=await this._getCompendiumActions(n);this.actionHandler.addActionsToActionList(e,i)}}}async _getCompendiumActions(e){const t=await this.getCompendiumEntries(e),i=this.getCompendiumActionType(e);return t.map((t=>({id:t._id,name:t.name,encodedValue:[i,e,t._id].join("|"),img:Utils.getImage(t),selected:!0})))}async getCompendiumEntries(e){const t=game.packs.get(e);if(!t)return[];const i=t.index.size>0?t.index:await t.getIndex();if("Playlist"===t.documentName){return await this._getPlaylistEntries(t)}return i}async _getPlaylistEntries(e){return(await e.getContent()).reduce(((e,t)=>(t.sounds.forEach((i=>{e.push({_id:`${t._id}>${i._id}`,name:i.name})})),e)),[])}getCompendiumActionType(e){const t=game?.packs?.get(e);if(!t)return"";switch(t.documentName){case"Macro":return"compendiumMacro";case"Playlist":return"compendiumPlaylist";default:return"compendiumEntry"}}}class MacroActionHandler{actionHandler;constructor(e){this.actionHandler=e,this.categoryManager=e.categoryManager}async buildMacroActions(){const e="custom",t=this.categoryManager.getFlattenedSubcategories({type:e}).flatMap((e=>e.id));if(!t)return;const i=await this._getActions();for(const n of t){const t={id:n,type:e};this.actionHandler.addActionsToActionList(i,t)}}async _getActions(){const e="macro";return game.macros.filter((e=>{const t=e.ownership;return t[game.userId]?t[game.userId]>0:t.default>0})).map((t=>({id:t.id,name:t.name,encodedValue:[e,t.id].join("|"),img:Utils.getImage(t),selected:!0})))}}class ActionHandler{furtherActionHandlers=[];delimiter="|";constructor(e){this.categoryManager=e,this.flattenedSubcategories=e.flattenedSubcategories,this.character=null,this.genericActionHandler=new GenericActionHandler(this),this.compendiumActionHandler=new CompendiumActionHandler(this),this.macroActionHandler=new MacroActionHandler(this),this.actionList=[],this.userActionList=[],this.savedUserActionList=[],this.savedActorActionList=[],this.displayIcons=Utils.getSetting("displayIcons")}resetActionHandler(){this.genericActionHandler=new GenericActionHandler(this),this.compendiumActionHandler=new CompendiumActionHandler(this),this.macroActionHandler=new MacroActionHandler(this),this.actionList=[],this.userActionList=[],this.savedUserActionList=[],this.savedActorActionList=[],this.displayIcons=Utils.getSetting("displayIcons")}async buildActionList(e){return Logger.debug("Building action list...",{character:e}),await this.categoryManager.resetCategoryManager(),this.character=e,this.savedUserActionList=await this._getSavedUserActionList(e),this.character&&(this.savedActorActionList=await this._getSavedActorActionList(e)),this.actionList=await this._buildEmptyActionList(e),await this.categoryManager.flattenSubcategories(this.actionList),await Promise.all([this._buildSystemActions(e),this._buildGenericActions(e),this._buildCompendiumActions(),this._buildMacroActions()]),await this.buildFurtherActions(e),await this.categoryManager.saveDerivedSubcategories(),await this._setCharacterLimit(),this.character&&await this._saveActorActionList(e),Logger.debug("Action list built",{actionList:this.actionList,character:e}),this.actionList}_getSavedUserActionList(e){Logger.debug("Retrieving saved action list from user...",{character:e});const t=Utils.getUserFlag("categories");if(!t)return[];const i=Utils.deepClone(t);return Logger.debug("Action list from user retrieved",{savedUserActionList:i,character:e}),i}_getSavedActorActionList(t){Logger.debug("Retrieving saved action list from actor...",{character:t});const i=t?.actor;if(!i)return[];const n=i.getFlag(e.ID,"categories");if(!n)return[];const o=Utils.deepClone(n);return Logger.debug("Action list from actor retrieved",{savedActorActionList:o,character:t}),o}_buildEmptyActionList(e){Logger.debug("Building empty action list...",{character:e});let t="";Utils.getSetting("displayCharacterName")&&(t=e?.name??"Multiple");const i={hudTitle:t,tokenId:e?.token?.id??"multi",actorId:e?.actor?.id??"multi",categories:[]},n=this.savedUserActionList?.length?this.savedUserActionList:Utils.getUserFlag("default.categories");for(const e of n){i.categories.push(this.categoryManager.createCategory(e));const t=i.categories.length-1,n=i.categories[t],addSubcategories=(e,t)=>{if(t)for(const i of t)if(e.subcategories.push(this.categoryManager.createSubcategory(i)),i?.subcategories?.length){const t=e.subcategories.length-1,n=e.subcategories[t];addSubcategories(n,i.subcategories)}};addSubcategories(n,e.subcategories,e.nestId)}return Logger.debug("Empty action list built",{emptyActionList:i,character:e}),i}async _buildSystemActions(e){Logger.debug("Building system actions...",{character:e});const t=this.categoryManager.getFlattenedSubcategories({level:"subcategory"}).map((e=>e.id));await this.buildSystemActions(e,t),Logger.debug("System actions built",{actionList:this.actionList,character:e})}async buildSystemActions(e,t){}_buildGenericActions(e){Logger.debug("Building generic actions...",{character:e}),this.genericActionHandler.buildGenericActions(e),Logger.debug("Generic actions built",{actionList:this.actionList,character:e})}async _buildCompendiumActions(){Logger.debug("Building compendium actions..."),await this.compendiumActionHandler.buildCompendiumActions(),Logger.debug("Compendium actions built",{actionList:this.actionList})}async _buildMacroActions(){Logger.debug("Building macro actions..."),await this.macroActionHandler.buildMacroActions(),Logger.debug("Macro actions built",{actionList:this.actionList})}async buildFurtherActions(e){this.furtherActionHandlers.forEach((t=>t.extendActionList(e)))}async getAvailableActionsAsTagifyEntries(e){if(!this.actionList)return;return(await Utils.getSubcategoryByNestId(this.actionList.categories,e)).actions.map((e=>this._toTagifyEntry(e)))}async getSelectedActionsAsTagifyEntries(e){if(!this.actionList)return;return(await Utils.getSubcategoryByNestId(this.actionList.categories,e)).actions.filter((e=>!0===e.selected)).map((e=>this._toTagifyEntry(e)))}async registerDefaultCategories(){}addSubcategoryInfo(e){const t=e?.id,i=e?.info;if(!t||!i)return;this.categoryManager.getFlattenedSubcategories(e).forEach((e=>{e.info1=i.info1,e.info2=i.info2,e.info3=i.info3}))}async addSubcategoryToActionList(e,t){const i=e?.id;if(!i)return;const n=this.categoryManager.getFlattenedSubcategories({...e,level:s.SUBCATEGORY});if(n)for(const i of n){const n=`${i.nestId}_${t.id}`;if(this.categoryManager.getFlattenedSubcategories({...t,nestId:n}).length)continue;const o=this.categoryManager.createSubcategory({...t,nestId:n});i.subcategories.push(o),this.categoryManager.addToFlattenedSubcategories(o),this.categoryManager.addToDerivedSubcategories({...e,nestId:i.nestId},o)}}async addActionsToActionList(e,t){if(!e.length)return;if(!t?.id)return;const i=this.categoryManager.getFlattenedSubcategories(t);if(i)for(const t of i){const i=t.nestId,n=t.type,o=(await Utils.getSubcategoryByNestId(this.savedActorActionList,{nestId:i,type:n}))?.actions??[],s=[];for(const t of o){const i=e.find((e=>e.encodedValue===t.encodedValue));if(i){const e={...i,fullName:i.name,selected:t.selected??!0};s.push(e)}}for(const t of e){if(!o.find((e=>e.encodedValue===t.encodedValue))){const e={...t,fullName:t.name,selected:!0};s.push(e)}}t.actions=s}}async _setCharacterLimit(){const e=this.categoryManager.getFlattenedSubcategories({level:"category"});for(const t of e){const e=t?.advancedCategoryOptions?.characterCount,i=this.categoryManager.getFlattenedSubcategories({nestId:t.nestId,level:"subcategory"});for(const t of i){const i=t.actions;if(0===i.length)continue;const n=t?.advancedCategoryOptions?.characterCount,o=n>=0?n:e;if((o||0===o)&&o>=0)for(const e of i)e.name.length<=o||(e.name=0!==o?e.name.split(" ").map((e=>e.slice(0,o))).join(" "):"")}}}async _saveActorActionList(t){if(Logger.debug("Saving actor action list...",{character:t}),!t?.actor)return;const i=t.actor,n=Utils.deepClone(this.actionList.categories);await i.setFlag(e.ID,"categories",n),Logger.debug("Actor action list saved",{actionList:this.actionList,character:t})}async saveActions(e,t){const i=await Utils.getSubcategoryByNestId(this.actionList.categories,t),n=i.actions,o=[];for(const t of e){const e=n.find((e=>e.encodedValue===t.id));if(e){const t={...e,selected:!0};o.push(t)}}for(const t of n){if(!e.find((e=>e.id===t.encodedValue))){const e={...t,selected:!1};o.push(e)}}i.actions=o,await this._saveActorActionList(this.character)}addFurtherActionHandler(e){Logger.debug("Adding further action handler...",{handler:e}),this.furtherActionHandlers.push(e)}_toTagifyEntry(e){return{id:e.encodedValue,value:e.fullName,type:"action",level:"action"}}sortItems(e){return new Map([...e.entries()].sort(((e,t)=>e[1].sort.localeCompare(t[1].sort))))}sortItemsByName(e){return new Map([...e.entries()].sort(((e,t)=>e[1].name.localeCompare(t[1].name))))}}class ActionListExtender extends ActionHandler{constructor(e){super(e)}extendActionList(e){}}class ItemMacroActionListExtender extends ActionListExtender{constructor(e){super(e.categoryManager),this.actionHandler=e,this.categoryManager=e.categoryManager}extendActionList(e){if(!e)return;const t=e.token?.id,i=e.actor?.id;if(!i)return;const n=Utils.getActor(i,t).items.filter((e=>e.flags?.itemacro?.macro?.command));let o;if(o=Utils.isModuleActive("midi-qol")?n.filter(this._isUnsupportedByMidiQoL).map((e=>e.id)):n.map((e=>e.id)),!o)return;if(0===o.length)return;const s=Utils.getSetting("itemMacro");if("original"===s)return;const a="itemMacro"===s;this.categoryManager.flattenedSubcategories.forEach((e=>{this._addSubcategoryActions(o,e,a)}))}_addSubcategoryActions(e,t,i){if(!t?.actions?.length)return;const n=[];t.actions.forEach((t=>{if(!e.includes(t.id))return;const o=this._createItemMacroAction(t,i);i||n.push(o)})),this._addActionsToSubcategory(t,n)}_createItemMacroAction(e,t){const i=t?e:Utils.deepClone(e);return i.fullName=`(M) ${i.fullName}`,i.name=`(M) ${i.name}`,i.encodedValue=`itemMacro ${i.encodedValue.substr(i.encodedValue.indexOf("|"))}`,i}_addActionsToSubcategory(e,t){t.forEach((t=>{const i=e.actions.findIndex((e=>e.id===t.id))+1;e.actions.splice(i,0,t)}))}_isUnsupportedByMidiQoL(e){return!e.getFlag("midi-qol","onUseMacroName")}}class RollHandler{preRollHandlers=[];throwInvalidValueErr(e){throw new Error(`Error handling button click: ${e}`)}async handleActionEvent(e,t){Logger.debug(`Handling event for action [${t}]`,{event:e}),this.registerKeyPresses(e);let i=!1;this.preRollHandlers.forEach((n=>{i||(i=n.prehandleActionEvent(e,t))})),i||(this._isMultiGenericAction(t)?await this._doMultiGenericAction(t):this.doHandleActionEvent(e,t))}doHandleActionEvent(e,t){}addPreRollHandler(e){Logger.debug(`Adding pre-roll handler ${e.constructor.name}`),this.preRollHandlers.push(e)}registerKeyPresses(e){this.rightClick=this.isRightClick(e),this.ctrl=this.isCtrl(e),this.alt=this.isAlt(e),this.shift=this.isShift(e)}doRenderItem(e,t,i){const n=Utils.getActor(e,t);Utils.getItem(n,i).sheet.render(!0)}isRenderItem(){return Utils.getSetting("renderItemOnRightClick")&&this.rightClick&&!(this.alt||this.ctrl||this.shift)}isRightClick(e){return 2===e?.originalEvent?.button}isAlt(e){return game.keyboard.isModifierActive(KeyboardManager.MODIFIER_KEYS.ALT)}isCtrl(e){return game.keyboard.isModifierActive(KeyboardManager.MODIFIER_KEYS.CONTROL)}isShift(e){return game.keyboard.isModifierActive(KeyboardManager.MODIFIER_KEYS.SHIFT)}_isMultiGenericAction(e){const t=e.split("|"),i=t[0],n=t[3];return"utility"===i&&n.includes("toggle")}async _doMultiGenericAction(e){const t=e.split("|")[3],i=Utils.getFirstControlledToken();"toggleVisibility"===t&&i.toggleVisibility(),"toggleCombat"===t&&i.toggleCombat(),Hooks.callAll("forceUpdateTokenActionHud")}}class PreRollHandler extends RollHandler{prehandleActionEvent(e,t){return!1}}class CompendiumMacroPreHandler extends PreRollHandler{prehandleActionEvent(e,t){const i=t.split("|");if(i.length<2)return!1;let n=null,s=null,a=null;if(2===i.length&&(n=i[0],a=i[1]),3===i.length&&(n=i[0],s=i[1],a=i[2]),!o.includes(n))return!1;switch(n){case"compendiumEntry":this.handleCompendium(s,a);break;case"compendiumMacro":this.handleMacroCompendium(s,a);break;case"compendiumPlaylist":this.handlePlaylistCompendium(s,a);break;case"macro":this.handleMacro(a);break;default:return!1}return!0}handleCompendium(e,t){game.packs.get(e).getDocument(t).then((e=>e.sheet.render(!0)))}handleMacroCompendium(e,t){game.packs.get(e).getDocument(t).then((e=>e.execute()))}async handlePlaylistCompendium(e,t){const i=game.packs.get(e),n=t.split(">"),o=n[0],s=n[1],a=(await i.getDocument(o)).sounds.find((e=>e._id===s));AudioHelper.play({src:a.path},{})}handleMacro(e){game.macros.find((t=>t.id===e)).execute()}}class ItemMacroPreRollHandler extends PreRollHandler{prehandleActionEvent(e,t){this.registerKeyPresses(e);const i=t.split("|");if(4!==i.length)return!1;const n=i[0],o=i[1],s=i[2],a=i[3];return"itemMacro"===n&&(this.isRenderItem()?(this.doRenderItem(o,s,a),!0):this._tryExecuteItemMacro(e,o,s,a))}_tryExecuteItemMacro(e,t,i,n){const o=Utils.getActor(t,i),s=Utils.getItem(o,n);try{s.executeMacro()}catch(e){return Logger.debug("ItemMacro Error",e),!1}return!0}}class SystemManager{constructor(){this.coreModuleId=e.ID}doGetCategoryManager(){}doGetActionHandler(){}doGetRollHandler(e){}getAvailableRollHandlers(){}doRegisterSettings(e){}async doRegisterDefaultFlags(){}async registerDefaultFlags(){await Utils.unsetUserFlag("default"),await this.doRegisterDefaultFlags()}async getActionHandler(e){const t=this.doGetActionHandler(e);return this.addActionExtenders(t),t}addActionExtenders(e){Utils.isModuleActive("itemacro")&&e.addFurtherActionHandler(new ItemMacroActionListExtender(e))}async getCategoryManager(){const e=this.doGetCategoryManager();return await e.init(),e}getRollHandler(){let e=Utils.getSetting("rollHandler");"core"===e||Utils.isModuleActive(e)||(Logger.error(e,Utils.i18n("tokenActionHud.handlerNotFound")),e="core",Utils.setSetting("rollHandler",e));const t=this.doGetRollHandler(e);return this.addPreHandlers(t),t}addPreHandlers(e){e.addPreRollHandler(new CompendiumMacroPreHandler),Utils.isModuleActive("itemacro")&&e.addPreRollHandler(new ItemMacroPreRollHandler)}registerSettings(){const e=this.getAvailableRollHandlers();registerSettings(this,e)}static addHandler(e,t){if(Utils.isModuleActive(t)){const i=Utils.getModuleTitle(t);mergeObject(e,{[t]:i})}}}class CategoryManager{categories=[];constructor(){this.flattenedSubcategories=[],this.derivedSubcategories=new Map}async resetCategoryManager(){this.flattenedSubcategories=[],this.derivedSubcategories=new Map}async copyUserFlags(t,i){if(!t||!i.length)return!1;Logger.debug("Copying user flags...");const n=game.users.get(t).getFlag(e.ID,"categories");return"string"==typeof i?game.users.get(i).setFlag(e.ID,"categories",n):Array.isArray(i)&&i.forEach((t=>{game.users.get(t).setFlag(e.ID,"categories",n)})),Logger.debug("User flags copied"),!0}async resetActorFlags(){Logger.debug("Resetting actor flags...");const t=game.actors.filter((t=>t.getFlag(e.ID,"categories")));t&&t.forEach((t=>{Logger.debug(`Resetting flags for actor [${t.id}]`,{actor:t}),t.unsetFlag(e.ID,"categories")})),Logger.debug("Actor flags reset")}async resetUserFlags(){Logger.debug("Resetting user flags..."),await Utils.unsetUserFlag("categories"),this.resetCategoryManager(),await this._registerDefaultCategories(),Logger.debug("User flags reset")}async init(){const e=Utils.getUserFlag("categories");if(!e||!e.length)return this._registerDefaultCategories();Logger.debug("Retrieved saved categories",{savedCategories:e})}async _registerDefaultCategories(){const e=Utils.getUserFlag("default.categories");e&&(await Utils.setUserFlag("categories",e),Logger.debug("Registered default categories",{defaultCategories:e}))}createCategory(e){const t=Utils.deepClone(e);return{id:t?.id,nestId:t?.nestId??this.id,name:t?.name,level:s.CATEGORY,advancedCategoryOptions:t?.advancedCategoryOptions??{},cssClass:"",subcategories:[]}}createSubcategory(e){const t=Utils.deepClone(e);return t?.advancedCategoryOptions||(t.advancedCategoryOptions={}),void 0===t?.advancedCategoryOptions?.showTitle&&(t.advancedCategoryOptions.showTitle=!0),t.subtitleClass=t?.advancedCategoryOptions?.showTitle?"":"tah-hidden",{id:t?.id,nestId:t?.nestId,name:t?.name,type:t?.type??a.CUSTOM,level:s.SUBCATEGORY,advancedCategoryOptions:t?.advancedCategoryOptions??{showTitle:!0},hasDerivedSubcategories:t?.hasDerivedSubcategories??!1,subtitleClass:t?.subtitleClass??"",isSelected:t?.isSelected??!0,info1:t?.info1??"",info2:t?.info2??"",info3:t?.info3??"",actions:[],subcategories:[]}}flattenSubcategories(e){this.flattenedSubcategories=Utils.getSubcategories(e.categories)}getFlattenedSubcategories(e={}){const t=e.id,i=e.nestId,n=e.type,o=e.level;return this.flattenedSubcategories?this.flattenedSubcategories.filter((e=>(!t||e.id===t)&&(!i||e?.nestId?.startsWith(i))&&(!n||e.type===n)&&(!o||e.level===o))):[]}addToFlattenedSubcategories(e){this.getFlattenedSubcategories(e).length>0||this.flattenedSubcategories.push(e)}async saveCategories(e){if(!e)return;const t=game.tokenActionHud.actionHandler.actionList.categories,i=[];for(const n of e){const e=n.id,o=t.find((t=>t.nestId===e)),s=Utils.deepClone(o?.subcategories)??null;i.push({nestId:n.id,id:n.id,name:n.name,subcategories:s})}i&&await this.saveUserActionList(i)}async saveSubcategories(e,t,i=!0){Logger.debug("Saving subcategories...",{subcategories:e,parentSubcategoryData:t});const n=game.tokenActionHud.actionHandler.actionList.categories,o=Utils.deepClone(n),s=await Utils.getSubcategoryByNestId(o,t);if(!s)return;const a=t.nestId,r=[];for(const t of e)r.push(this.createSubcategory({...t,nestId:`${a}_${t.id}`,isSelected:t.isSelected??!0}));if(t.hasDerivedSubcategories)for(const t of s.subcategories){const n=Utils.deepClone(t),o=e.find((e=>e.id===n.id));i&&(n.isSelected=!1,n.actions=[]),o||r.push(n)}s.subcategories=r,t.advancedCategoryOptions&&(s.advancedCategoryOptions=t.advancedCategoryOptions),await this.saveUserActionList(o),Logger.debug("Subcategories saved",{actionList:o})}addToDerivedSubcategories(e,t){const i=e.nestId,n=Utils.deepClone(t,{strict:!0});this.derivedSubcategories.has(i)||this.derivedSubcategories.set(i,[]),this.derivedSubcategories.get(i).push(n)}async saveDerivedSubcategories(){for(const[e,t]of this.derivedSubcategories){const i=Utils.deepClone(t,{strict:!0}),n=!1;await this.saveSubcategories(i,{nestId:e,type:a.SYSTEM,hasDerivedSubcategories:!0},n)}}async saveUserActionList(e){Logger.debug("Saving user action list...");const t=Utils.deepClone(e);await Utils.setUserFlag("categories",t),Logger.debug("User action list saved",{actionList:t})}async getAdvancedCategoryOptions(e){const t=(await Utils.getSubcategoryByNestId(this.flattenedSubcategories,e))?.advancedCategoryOptions;return t??null}async getSelectedCategoriesAsTagifyEntries(){const e=Utils.getUserFlag("categories");if(e)return e.map((e=>this._toTagifyEntry(e)))}async getSelectedSubcategoriesAsTagifyEntries(e){const t=game.tokenActionHud.actionHandler.actionList.categories;if(!t)return[];const i=await Utils.getSubcategoryByNestId(t,e);if(!i)return[];if(!i.subcategories)return[];const n=i.subcategories.filter((e=>e.isSelected)).map((e=>this._toTagifyEntry(e)));return n||[]}async getAvailableSubcategoriesAsTagifyEntries(e){const t=e?.hasDerivedSubcategories;if("true"===t)return await this.getDerivedSubcategoriesAsTagifyEntries(e);const i=await this.getSystemSubcategoriesAsTagifyEntries(),n=await this.getCompendiumSubcategoriesAsTagifyEntries(),o=[];return o.push(...i,...n),o}async getDerivedSubcategoriesAsTagifyEntries(e){const t=e.nestId;return this.getFlattenedSubcategories({nestId:t,type:a.SYSTEM_DERIVED}).map((e=>this._toTagifyEntry(e)))}async getSystemSubcategoriesAsTagifyEntries(){return Utils.getUserFlag("default.subcategories").map((e=>this._toTagifyEntry(e)))}async getCompendiumSubcategoriesAsTagifyEntries(){return game.packs.filter((e=>n.includes(e.documentName))).filter((e=>game.user.isGM||!e.private)).map((e=>({id:e.metadata.id.replace(".","-"),value:e.metadata.label,type:a.COMPENDIUM,level:a.SUBCATEGORY})))}isLinkedCompendium(e){return this.categories.some((t=>t.subcategories?.some((t=>t.compendiumId===e))))}_toTagifyEntry(e){return{id:e.id,value:e.name,type:e.type,level:s.SUBCATEGORY,hasDerivedSubcategories:e.hasDerivedSubcategories??"false"}}}export{i as ACTION_TYPE,ActionHandler,ActionListExtender,o as COMPENDIUM_ACTION_TYPES,n as COMPENDIUM_PACK_TYPES,CategoryManager,CategoryResizer,CompendiumActionHandler,CompendiumMacroPreHandler,t as DELIMITER,GenericActionHandler,ItemMacroActionListExtender,ItemMacroPreRollHandler,Logger,e as MODULE,MacroActionHandler,MigrationManager,PreRollHandler,RollHandler,s as SUBCATEGORY_LEVEL,a as SUBCATEGORY_TYPE,SystemManager,TagDialog,TagDialogHelper,Timer,TokenActionHud,Utils,registerSettings};
