class Logger{static info(...e){console.log("Token Action HUD Info |",...e)}static error(...e){console.error("Token Action HUD Error |",...e)}static debug(...e){(game.tokenActionHud?game.tokenActionHud.isDebug:getSetting("debug"))&&console.log("Token Action HUD Debug |",...e)}}function checkAllow(e){return e>=getSetting("allow")}function getSetting(e,t=null){let n=t??null;try{n=game.settings.get("token-action-hud-core",e)}catch{Logger.debug(`Setting '${e}' not found`)}return n}async function setSetting(e,t){game.settings.settings.get(`token-action-hud-core.${e}`)?(t=await game.settings.set("token-action-hud-core",e,t),Logger.debug(`Setting '${e}' set to '${t}'`)):Logger.debug(`Setting '${e}' not found`)}function switchCSS(e){const t=[{setting:"compact",file:"tah-compact"},{setting:"foundryVTT",file:"tah-foundry-vtt"},{setting:"dorakoUI",file:"tah-dorako"}];for(const n of t){const t=["modules/token-action-hud-core/",`styles/${n.file}`];n.setting===e?Object.values(document.styleSheets).find((e=>e.href?.includes(t[0])&&e.href?.includes(t[1]))).disabled=!1:Object.values(document.styleSheets).find((e=>e.href?.includes(t[0])&&e.href?.includes(t[1]))).disabled=!0}}function registerHandlebars(){Handlebars.registerHelper("cap",(function(e){return!e||e.length<1?"":e[0].toUpperCase()+e.slice(1)}));const reduceOp=function(e,t){(e=Array.from(e)).pop();const n=e.shift();return e.reduce(t,n)};Handlebars.registerHelper({eq:function(){return reduceOp(arguments,((e,t)=>e===t))},ne:function(){return reduceOp(arguments,((e,t)=>e!==t))},lt:function(){return reduceOp(arguments,((e,t)=>e<t))},gt:function(){return reduceOp(arguments,((e,t)=>e>t))},lte:function(){return reduceOp(arguments,((e,t)=>e<=t))},gte:function(){return reduceOp(arguments,((e,t)=>e>=t))},and:function(){return reduceOp(arguments,((e,t)=>e&&t))},or:function(){return reduceOp(arguments,((e,t)=>e||t))}}),Handlebars.registerHelper("activeText",(function(e){return getSetting("activeCssAsText")?e.fn(this):e.inverse(this)}))}function getSubcategories(e,t={}){if(!e)return;const n=t?.id,i=t?.type;e=Array.isArray(e)?e:Object.values(e);let o=[];for(const a of e)if(n&&a.id!==n||i&&a.type!==i||o.push(a),a.subcategories.length>0){const e=getSubcategories(a.subcategories,t);e&&(o=o.concat(e.filter((e=>void 0!==e))))}return o.length?o:null}async function getSubcategoryByNestId(e,t={}){const n="string"==typeof t?t:t?.nestId,i=t?.type??"system";if(!n)return;const o=n.split("_");return await async function findSubcategory(e,t){e=Array.isArray(e)?e:Object.values(e);for(const n of e)if(n.id===t[0]){if(1===t.length)return n.type&&n.type!==i?void 0:n;if(0===n.subcategories.length)return;t.shift();const e=await findSubcategory(n.subcategories,t);if(e)return e}}(e,o)}const updateFunc=e=>{Logger.debug("Settings updated. Refreshing HUD"),game.tokenActionHud&&game.tokenActionHud.updateSettings()};let e;const registerSettings=function(t,n,i){e=t,game.settings.register(e,"startup",{name:"One-Time Startup Prompt",scope:"world",config:!1,type:Boolean,default:!1}),game.settings.register(e,"rollHandler",{name:game.i18n.localize("tokenActionHud.settings.rollHandler.name"),hint:game.i18n.localize("tokenActionHud.settings.rollHandler.hint"),scope:"world",config:!0,type:String,choices:i,default:"core",onChange:e=>{updateFunc()}}),game.settings.register(e,"style",{name:game.i18n.localize("tokenActionHud.settings.style.name"),hint:game.i18n.localize("tokenActionHud.settings.style.hint"),scope:"client",config:!0,type:String,default:"foundryVTT",choices:{compact:"Compact",foundryVTT:"Foundry VTT",dorakoUI:"Dorako UI"},onChange:e=>{switchCSS(e)}}),game.settings.register(e,"direction",{name:game.i18n.localize("tokenActionHud.settings.direction.name"),hint:game.i18n.localize("tokenActionHud.settings.direction.hint"),scope:"client",config:!0,type:String,default:"down",choices:{up:game.i18n.localize("tokenActionHud.settings.direction.choices.up"),down:game.i18n.localize("tokenActionHud.settings.direction.choices.down")},onChange:e=>{updateFunc()}}),game.settings.register(e,"scale",{name:game.i18n.localize("tokenActionHud.settings.scale.name"),hint:game.i18n.localize("tokenActionHud.settings.scale.hint"),scope:"client",config:!0,type:Number,range:{min:.5,max:2,step:.05},default:1,onChange:e=>{updateFunc()}}),game.settings.register(e,"drag",{name:game.i18n.localize("tokenActionHud.settings.drag.name"),hint:game.i18n.localize("tokenActionHud.settings.drag.hint"),scope:"client",config:!0,type:Boolean,default:!0,onChange:e=>{updateFunc()}}),initColorSettings(e),game.settings.register(e,"enable",{name:game.i18n.localize("tokenActionHud.settings.enable.name"),hint:game.i18n.localize("tokenActionHud.settings.enable.hint"),scope:"client",config:!0,type:Boolean,default:!0,onChange:e=>{updateFunc()}}),game.settings.register(e,"allow",{name:game.i18n.localize("tokenActionHud.settings.allow.name"),hint:game.i18n.localize("tokenActionHud.settings.allow.hint"),scope:"world",config:!0,type:String,choices:{4:game.i18n.localize("tokenActionHud.settings.allow.choices.4"),3:game.i18n.localize("tokenActionHud.settings.allow.choices.3"),2:game.i18n.localize("tokenActionHud.settings.allow.choices.2"),1:game.i18n.localize("tokenActionHud.settings.allow.choices.1")},default:1,onChange:foundry.utils.debounce((()=>window.location.reload()),100)}),game.settings.register(e,"alwaysShowHud",{name:game.i18n.localize("tokenActionHud.settings.alwaysShowHud.name"),hint:game.i18n.localize("tokenActionHud.settings.alwaysShowHud.hint"),scope:"client",config:!0,type:Boolean,default:!0,onChange:e=>{updateFunc()}}),game.settings.register(e,"displayCharacterName",{name:game.i18n.localize("tokenActionHud.settings.displayCharacterName.name"),hint:game.i18n.localize("tokenActionHud.settings.displayCharacterName.hint"),scope:"client",config:!0,type:Boolean,default:!0,onChange:e=>{updateFunc()}}),game.settings.register(e,"displayIcons",{name:game.i18n.localize("tokenActionHud.settings.displayIcons.name"),hint:game.i18n.localize("tokenActionHud.settings.displayIcons.hint"),scope:"client",config:!0,type:Boolean,default:!0,onChange:e=>{updateFunc()}}),game.settings.register(e,"clickOpenCategory",{name:game.i18n.localize("tokenActionHud.settings.clickOpenCategory.name"),hint:game.i18n.localize("tokenActionHud.settings.clickOpenCategory.hint"),scope:"client",config:!0,type:Boolean,default:!1,onChange:e=>{updateFunc()}}),game.settings.register(e,"renderItemOnRightClick",{name:game.i18n.localize("tokenActionHud.settings.renderItemOnRightClick.name"),hint:game.i18n.localize("tokenActionHud.settings.renderItemOnRightClick.hint"),scope:"client",config:!0,type:Boolean,default:!0,onChange:e=>{updateFunc()}}),game.modules.get("itemacro")?.active&&game.settings.register(e,"itemMacro",{name:game.i18n.localize("tokenActionHud.settings.itemMacro.name"),hint:game.i18n.localize("tokenActionHud.settings.itemMacro.hint"),scope:"client",config:!0,type:String,choices:{both:game.i18n.localize("tokenActionHud.settings.itemMacro.choices.both"),itemMacro:game.i18n.localize("tokenActionHud.settings.itemMacro.choices.itemMacro"),original:game.i18n.localize("tokenActionHud.settings.itemMacro.choices.original")},default:"both",onChange:e=>{updateFunc()}}),game.settings.register(e,"activeCssAsText",{name:game.i18n.localize("tokenActionHud.settings.activeCssAsText.name"),hint:game.i18n.localize("tokenActionHud.settings.activeCssAsText.hint"),scope:"client",config:!0,type:Boolean,default:!1,onChange:e=>{updateFunc()}}),game.settings.register(e,"debug",{name:game.i18n.localize("tokenActionHud.settings.debug.name"),hint:game.i18n.localize("tokenActionHud.settings.debug.hint"),scope:"client",config:!0,type:Boolean,default:!1,onChange:e=>{updateFunc()}}),game.settings.register(e,"reset",{name:game.i18n.localize("tokenActionHud.settings.reset.name"),hint:game.i18n.localize("tokenActionHud.settings.reset.hint"),scope:"client",config:!0,type:Boolean,default:!1,onChange:e=>{e&&(setSetting("reset",!1),game.tokenActionHud.reset())}}),n.doRegisterSettings(updateFunc),Logger.debug("Available roll handlers",{rollHandlers:i})};function initColorSettings(e){let t=null;switch(game.modules.get("lib-themer")?.active?t="lib-themer":game.modules.get("color-picker")?.active?t="color-picker":game.modules.get("colorsettings")?.active&&(t="colorsettings"),t){case"lib-themer":Hooks.once("lib-themer.Ready",(t=>{t.register({id:e,title:game.modules.get(e).title,"--tah-background":{name:"tokenActionHud.settings.background.name",hint:"tokenActionHud.settings.background.hint",type:"color",default:"#00000000"},"--tah-button":{name:"tokenActionHud.settings.buttonBackgroundColor.name",hint:"tokenActionHud.settings.buttonBackgroundColor.hint",type:"color",default:"#00000080",colors:{buttons:!0}}})}));break;case"color-picker":"object"==typeof ColorPicker?registerColorSettings(e,t):Hooks.once("colorPickerReady",(()=>{registerColorSettings(e,t)}));break;case"colorsettings":Hooks.once("ready",(()=>{try{window.Ardittristan.ColorSetting.tester,registerColorSettings(e,t)}catch{}}))}}function registerColorSettings(e,t){const n={key:"background",name:game.i18n.localize("tokenActionHud.settings.background.name"),hint:game.i18n.localize("tokenActionHud.settings.background.hint"),scope:"client",restricted:!1,default:"#00000000",onChange:e=>{document.querySelector(":root").style.setProperty("--tah-background",e),updateFunc()}},i={key:"buttonBackgroundColor",name:game.i18n.localize("tokenActionHud.settings.buttonBackgroundColor.name"),hint:game.i18n.localize("tokenActionHud.settings.buttonBackgroundColor.hint"),scope:"client",restricted:!0,default:"#00000080",onChange:e=>{document.querySelector(":root").style.setProperty("--tah-button",e),updateFunc()}},o={key:"buttonBorderColor",name:game.i18n.localize("tokenActionHud.settings.buttonBorderColor.name"),hint:game.i18n.localize("tokenActionHud.settings.buttonBorderColor.hint"),scope:"client",restricted:!0,default:"#000000ff",onChange:e=>{document.querySelector(":root").style.setProperty("--tah-button-outline",e),updateFunc()}};if("color-picker"===t){const t={format:"hexa",alphaChannel:!0};ColorPicker.register(e,n.key,{name:n.name,hint:n.hint,scope:n.scope,restricted:n.restricted,default:n.default,onChange:n.onChange},t),ColorPicker.register(e,i.key,{name:i.name,hint:i.hint,scope:i.scope,restricted:i.restricted,default:i.default,onChange:i.onChange},t),ColorPicker.register(e,o.key,{name:o.name,hint:o.hint,scope:o.scope,restricted:o.restricted,default:o.default,onChange:o.onChange},t)}else"colorsettings"===t&&(new window.Ardittristan.ColorSetting(e,n.key,{name:n.name,hint:n.hint,scope:n.scope,restricted:n.restricted,defaultColor:n.default,onChange:n.onChange,insertAfter:`${e}.scale`}),new window.Ardittristan.ColorSetting(e,i.key,{name:i.name,hint:i.hint,scope:i.scope,restricted:i.restricted,defaultColor:i.default,onChange:i.onChange,insertAfter:`${e}.${n.key}`}),new window.Ardittristan.ColorSetting(e,o.key,{name:o.name,hint:o.hint,scope:o.scope,restricted:o.restricted,defaultColor:o.default,onChange:o.onChange,insertAfter:`${e}.${i.key}`}));Hooks.once("ready",(()=>{document.querySelector(":root").style.setProperty("--tah-background",getSetting("background")??"#00000000"),document.querySelector(":root").style.setProperty("--tah-button",getSetting("buttonBackgroundColor")??"#00000080"),document.querySelector(":root").style.setProperty("--tah-button-outline",getSetting("buttonBorderColor")??"#000000ff")}))}class ActionList{constructor(e="",t="",n=""){this.hudTitle=e,this.tokenId=t,this.actorId=n,this.categories=[]}}class ActionCategory{constructor(e="",t=""){this.id=e,this.nestId=e,this.name=t,this.level="category",this.cssClass="",this.subcategories=[]}}class ActionSubcategory{constructor(e={}){this.id=e?.id,this.nestId=e?.nestId,this.name=e?.name,this.type=e?.type??"custom",this.level="subcategory",e?.info1&&(this.info1=e?.info1),e?.info2&&(this.info1=e?.info2),e?.info3&&(this.info1=e?.info3),this.actions=[],this.subcategories=[]}}class GenericActionHandler{baseHandlers;constructor(e){this.baseHandler=e}buildGenericActions(e){this._buildConditions(e),this._buildUtilities(e)}_buildConditions(e){}_buildUtilities(e){e?this._buildSingleTokenUtilities(e):this._buildMultipleTokenUtilities()}_buildSingleTokenUtilities(e){const t=e.actor?.id,n=e.token?.id;if(!n)return;const i="utility",o=[],a="toggleCombat",s=canvas.tokens.placeables.find((e=>e.id===n)).inCombat?this.baseHandler.i18n("tokenActionHud.removeFromCombat"):this.baseHandler.i18n("tokenActionHud.addToCombat"),r=[i,t,n,a].join(this.baseHandler.delimiter),c={id:a,name:s,encodedValue:r,selected:!0};if(o.push(c),game.user.isGM){const e="toggleVisibility",a=canvas.tokens.placeables.find((e=>e.id===n)).document.hidden?this.baseHandler.i18n("tokenActionHud.makeVisible"):this.baseHandler.i18n("tokenActionHud.makeInvisible"),s=[i,t,n,e].join(this.baseHandler.delimiter),r={id:e,name:a,encodedValue:s,selected:!0};o.push(r)}this.baseHandler.addActionsToActionList(o,"token")}_buildMultipleTokenUtilities(){const e="utility",t="multi",n="multi",i=canvas.tokens.controlled,o=[],a="toggleCombat",s=i.every((e=>e.inCombat))?this.baseHandler.i18n("tokenActionHud.removeFromCombat"):this.baseHandler.i18n("tokenActionHud.addToCombat"),r=[e,t,n,a].join(this.baseHandler.delimiter),c={id:a,name:s,encodedValue:r};if(o.push(c),game.user.isGM){const a="toggleVisibility",s=i.every((e=>!e.document.hidden))?this.baseHandler.i18n("tokenActionHud.makeVisible"):this.baseHandler.i18n("tokenActionHud.makeInvisible"),r=[e,t,n,a].join(this.baseHandler.delimiter),c={id:a,name:s,encodedValue:r};o.push(c)}this.baseHandler.addActionsToActionList(o,"token")}}class CompendiumActionHandler{baseHandler;constructor(e){this.baseHandler=e}async buildCompendiumActions(){const e=this.baseHandler.getFlattenedSubcategories({subcategoryType:"compendium"}).flatMap((e=>e.id));if(!e)return;const t=game.packs.filter((e=>["JournalEntry","Macro","RollTable","Playlist"].includes(e.documentName))).filter((e=>game.user.isGM||!e.private)).map((e=>e.metadata.id));for(const n of t){const t=n.replace(".","-");if(e.includes(n.replace(".","-"))){const e=await this.getCompendiumActions(n);this.baseHandler.addActionsToActionList(e,t)}}}async getCompendiumActions(e){const t=await this.getCompendiumEntries(e),n=this.getCompendiumActionType(e);return t.map((t=>({id:t._id,name:t.name,encodedValue:[n,e,t._id].join(this.baseHandler.delimiter),img:this.baseHandler.getImage(t),selected:!0})))}async getCompendiumEntries(e){const t=game.packs.get(e);if(!t)return[];const n=t.index.size>0?t.index:await t.getIndex();if("Playlist"===t.documentName){return await this._getPlaylistEntries(t)}return n}async _getPlaylistEntries(e){return(await e.getContent()).reduce(((e,t)=>(t.sounds.forEach((n=>{e.push({_id:`${t._id}>${n._id}`,name:n.name})})),e)),[])}getCompendiumActionType(e){const t=game?.packs?.get(e);if(!t)return"";switch(t.documentName){case"Macro":return"compendiumMacro";case"Playlist":return"compendiumPlaylist";default:return"compendiumEntry"}}}class MacroActionHandler{baseHandler;constructor(e){this.baseHandler=e}async buildMacroActions(){const e=this.baseHandler.getFlattenedSubcategories({subcategoryType:"custom"}).flatMap((e=>e.id));if(!e)return;const t=await this.getActions();for(const n of e)this.baseHandler.addActionsToActionList(t,n)}async getActions(){const e="macro";return game.macros.filter((e=>{const t=e.ownership;return t[game.userId]?t[game.userId]>0:t.default>0})).map((t=>({id:t.id,name:t.name,encodedValue:[e,t.id].join(this.baseHandler.delimiter),img:this.baseHandler.getImage(t),selected:!0})))}}class ActionHandler{i18n=e=>game.i18n.localize(e);furtherActionHandlers=[];delimiter="|";constructor(e,t){this.character=e,this.categoryManager=t,this.genericActionHandler=new GenericActionHandler(this),this.compendiumActionHandler=new CompendiumActionHandler(this),this.macroActionHandler=new MacroActionHandler(this),this.actionList=[],this.subcategoriesList=[],this.savedUserActionList=[],this.savedActorActionList=[],this.derivedSubcategories=new Map,this.displayIcons=getSetting("displayIcons")}resetActionHandler(){this.genericActionHandler=new GenericActionHandler(this),this.compendiumActionHandler=new CompendiumActionHandler(this),this.macroActionHandler=new MacroActionHandler(this),this.actionList=[],this.subcategoriesList=[],this.savedUserActionList=[],this.savedActorActionList=[],this.derivedSubcategories=new Map,this.displayIcons=getSetting("displayIcons")}async buildActionList(e){return Logger.debug("Building action list...",{character:e}),this.character=e,this.savedUserActionList=this.getSavedUserActionList(e),this.savedActorActionList=this.getSavedActorActionList(e),this.actionList=this.buildEmptyActionList(e),this.flattenedSubcategories=this.flattenSubcategories(),await Promise.all([this._buildSystemActions(e),this._buildGenericActions(e),this._buildCompendiumActions(),this._buildMacroActions(),this.buildFurtherActions(e)]),await this.saveActionList(e),await this.saveDerivedSubcategories(),Logger.debug("Action list built",{actionList:this.actionList,character:e}),this.actionList}getSavedUserActionList(e){Logger.debug("Retrieving saved action list  from user...",{character:e});const t=game.user.getFlag("token-action-hud-core","categories");if(!t)return[];const n=t;return Logger.debug("Saved action list from user retrieved",{savedUserActionList:n,character:e}),n}getSavedActorActionList(e){Logger.debug("Retrieving saved action list from actor...",{character:e});const t=e?.actor;if(!t)return[];const n=t.getFlag("token-action-hud-core","categories");if(!n)return[];const i=n;return Logger.debug("Saved action list from actor retrieved",{savedActorActionList:i,character:e}),i}buildEmptyActionList(e){Logger.debug("Building empty action list...",{character:e});let t="";getSetting("displayCharacterName")&&(t=e?.name??"Multiple");const n=new ActionList(t,e?.token?.id??"multi",e?.actor?.id??"multi"),i=game.user.getFlag("token-action-hud-core","categories")??game.user.getFlag("token-action-hud-core","default.categories");for(const o of Object.entries(i)){n.categories.push(new ActionCategory(o[1].id,o[1].name));const a=n.categories.length-1;function addSubcategories(e,t,n=null){if(t)for(const n of Object.entries(t)){const t={id:n[1].id,nestId:n[0],name:n[1].name,type:n[1].type};if(e.subcategories.push(new ActionSubcategory(t)),n[1].subcategories){const t=e.subcategories.length-1;addSubcategories(e.subcategories[t],n[1].subcategories,n[0])}}}addSubcategories(n.categories[a],o[1].subcategories,o[0])}return Logger.debug("Empty action list built",{emptyActionList:deepClone(n),character:e}),n}async _buildSystemActions(e){Logger.debug("Building system actions...",{character:e});const t=Object.values(this.actionList.categories).filter((e=>e.subcategories)).flatMap((e=>Object.values(e.subcategories).filter((e=>"system"===e.type)).flatMap((e=>e.id))));await this.buildSystemActions(e,t),Logger.debug("System actions built",{actionList:deepClone(this.actionList),character:e})}async buildSystemActions(e,t){}_buildGenericActions(e){Logger.debug("Building generic actions...",{character:e}),this.genericActionHandler.buildGenericActions(e),Logger.debug("Generic actions built...",{actionList:deepClone(this.actionList),character:e})}async _buildCompendiumActions(){Logger.debug("Building compendium actions..."),await this.compendiumActionHandler.buildCompendiumActions(),Logger.debug("Compendium actions built",{actionList:deepClone(this.actionList)})}async _buildMacroActions(){Logger.debug("Building macro actions..."),await this.macroActionHandler.buildMacroActions(),Logger.debug("Macro actions built",{actionList:deepClone(this.actionList)})}buildFurtherActions(e){this.furtherActionHandlers.forEach((t=>t.extendActionList(e)))}async getActionsAsTagifyEntries(e){if(!this.actionList)return;return(await getSubcategoryByNestId(this.actionList.categories,e)).actions.map((e=>this.toTagifyEntry(e)))}async getSelectedActionsAsTagifyEntries(e){if(!this.actionList)return;return(await getSubcategoryByNestId(this.actionList.categories,e)).actions.filter((e=>!0===e.selected)).map((e=>this.toTagifyEntry(e)))}async registerDefaultCategories(){}addSubcategoryInfo(e={}){const t=e?.subcategoryId,n=e?.subcategoryType??"system",i=e?.subcategoryInfo;if(!t||!i)return;this.getFlattenedSubcategories({subcategoryId:t,subcategoryType:n}).forEach((e=>{e.info1=i.info1,e.info2=i.info2,e.info3=i.info3}))}addToflattenedSubcategories(e,t,n,i=[]){e.push({subcategoryId:t,subcategory:n,actions:i})}addSubcategoryToActionList(e,t){const n=e?.id,i=e?.type??"system";if(!n)return;const o=this.getFlattenedSubcategories({subcategoryId:n,subcategoryType:i});if(!o)return;const a=this.initializeSubcategory(t);for(const e of o){if(e.subcategories.find((e=>e.id===t.id)))return;const n=e.nestId,i=deepClone(a);i.nestId=`${n}_${i.id}`,e.subcategories.push(i);const o={id:i.id,name:i.name,type:i.type},s=this.derivedSubcategories.get(n);s?s.push(o):this.derivedSubcategories.set(n,[o]),this.flattenedSubcategories.push(i)}}async addActionsToActionList(e,t={}){if(!e.length)return;const n="string"==typeof t?t:t?.id;if(!n)return;const i=t?.type??"system",o=this.getFlattenedSubcategories({subcategoryId:n,subcategoryType:i});if(o)for(const t of o){const n=t.nestId,i=t.type,o=(await getSubcategoryByNestId(this.savedActorActionList,{nestId:n,type:i}))?.actions??[],a=[];for(const t of o){const n=e.find((e=>e.encodedValue===t.encodedValue));if(n){const e=structuredClone(n);e.selected=t.selected??!0,a.push(e)}}for(const t of e){if(!o.find((e=>e.encodedValue===t.encodedValue))){const e=structuredClone(t);e.selected=!0,a.push(e)}}t.actions=a}}async saveDerivedSubcategories(){if(0!==this.derivedSubcategories.size)for(const[e,t]of this.derivedSubcategories){const n={nestId:e,subcategoryType:"system-derived"},i=t;await game.tokenActionHud.categoryManager.saveSubcategories(i,null,n)}}async saveActionList(e){if(Logger.debug("Saving action list...",{character:e}),!e?.actor)return;const t=e.actor;await t.unsetFlag("token-action-hud-core","categories"),await t.setFlag("token-action-hud-core","categories",this.actionList.categories),Logger.debug("Action list saved",{actionList:this.actionList,character:e})}async saveActions(e,t){const n=await getSubcategoryByNestId(this.actionList.categories,t),i=n.actions,o=[];for(const t of e){const e=i.find((e=>e.encodedValue===t.id));if(e){const t=structuredClone(e);t.selected=!0,o.push(t)}}for(const t of i){if(!e.find((e=>e.id===t.encodedValue))){const e=structuredClone(t);e.selected=!1,o.push(e)}}n.actions=o,await this.saveActionList(this.character)}addFurtherActionHandler(e){Logger.debug("Adding further action handler...",{handler:e}),this.furtherActionHandlers.push(e)}flattenSubcategories(){return getSubcategories(this.actionList.categories)}getFlattenedSubcategories(e){const t=e.subcategoryId,n=e.subcategoryType;return this.flattenedSubcategories.filter((e=>e.id===t&&(!n||e.type===n)))}initializeEmptyCategory(e){const t=new ActionCategory;return t.id=e,t}initializeSubcategory(e){return new ActionSubcategory(e)}toTagifyEntry(e){return{id:e.encodedValue,value:e.name,type:"action",level:"action"}}getImage(e,t=[]){t.push("icons/svg/mystery-man.svg");let n="";return this.displayIcons&&(n=e?.img??e?.icon??""),t.includes(n)?"":n}sortItems(e){return new Map([...e.entries()].sort(((e,t)=>e[1].sort.localeCompare(t[1].sort))))}sortItemsByName(e){return new Map([...e.entries()].sort(((e,t)=>e[1].name.localeCompare(t[1].name))))}}class ActionListExtender extends ActionHandler{extendActionList(e){}}class ItemMacroActionListExtender extends ActionListExtender{static isModuleActive(e){const t=game.modules.get(e);return t&&t.active}extendActionList(e){if(!e)return;const t=e.token?.id,n=e.actor?.id;if(!n)return;const i=this.getActor(n,t).items.filter((e=>e.flags?.itemacro?.macro?.command));let o;if(o=ItemMacroActionListExtender.isModuleActive("midi-qol")?i.filter(this.isUnsupportedByMidiQoL).map((e=>e.id)):i.map((e=>e.id)),!o)return;if(0===o.length)return;const a=getSetting("itemMacro");if("original"===a)return;const s="itemMacro"===a;this.flattenedSubcategories.forEach((e=>{this.addSubcategoryActions(o,e,s)}))}addSubcategoryActions(e,t,n){t.subcategories&&t.subcategories.length>0&&t.subcategories.forEach((t=>this.addSubcategoryActions(e,t,n)));const i=[];t.actions.forEach((t=>{if(!e.includes(t.id))return;const o=this.createItemMacroAction(t,n);n||i.push(o)})),this.addActionsToSubcategory(t,i)}createItemMacroAction(e,t){const n=t?e:{},i=e.encodedValue.substr(e.encodedValue.indexOf(this.delimiter));return n.encodedValue="itemMacro"+i,n.id=e.id,n.name=`(M) ${e.name}`,n.img=e.img,n.icon1=e.icon1,n.icon2=e.icon2,n.icon3=e.icon3,n.info1=e.info1,n.info2=e.info2,n.info3=e.info3,n.selected=e.selected,n}addActionsToSubcategory(e,t){t.forEach((t=>{const n=e.actions.findIndex((e=>e.id===t.id))+1;e.actions.splice(n,0,t)}))}isUnsupportedByMidiQoL(e){return!e.getFlag("midi-qol","onUseMacroName")}getActor(e,t){let n=null;return t&&(n=canvas.tokens.placeables.find((e=>e.id===t))),n?n.actor:game.actors.get(e)}}class RollHandler{preRollHandlers=[];i18n=e=>game.i18n.localize(e);getActor(e,t){let n=null;return t&&(n=canvas.tokens.placeables.find((e=>e.id===t))),n?n.actor:game.actors.get(e)}getItem(e,t){return e.items.get(t)}getToken(e){return canvas.tokens.placeables.find((t=>t.id===e))}throwInvalidValueErr(e){throw new Error(`Error handling button click: ${e}`)}async handleActionEvent(e,t){Logger.debug(`Handling event for action [${t}]`,{event:e}),this.registerKeyPresses(e);let n=!1;this.preRollHandlers.forEach((i=>{n||(n=i.prehandleActionEvent(e,t))})),n||(this._isMultiGenericAction(t)?await this._doMultiGenericAction(t):this.doHandleActionEvent(e,t))}doHandleActionEvent(e,t){}addPreRollHandler(e){Logger.debug(`Adding pre-roll handler ${e.constructor.name}`),this.preRollHandlers.push(e)}registerKeyPresses(e){this.rightClick=this.isRightClick(e),this.ctrl=this.isCtrl(e),this.alt=this.isAlt(e),this.shift=this.isShift(e)}doRenderItem(e,t,n){const i=this.getActor(e,t);this.getItem(i,n).sheet.render(!0)}isRenderItem(){return getSetting("renderItemOnRightClick")&&this.rightClick&&!(this.alt||this.ctrl||this.shift)}isRightClick(e){return 2===e?.originalEvent?.button}isAlt(e){return game.keyboard.isModifierActive(KeyboardManager.MODIFIER_KEYS.ALT)}isCtrl(e){return game.keyboard.isModifierActive(KeyboardManager.MODIFIER_KEYS.CONTROL)}isShift(e){return game.keyboard.isModifierActive(KeyboardManager.MODIFIER_KEYS.SHIFT)}_isMultiGenericAction(e){const t=e.split("|"),n=t[0],i=t[3];return"utility"===n&&i.includes("toggle")}async _doMultiGenericAction(e){const t=e.split("|")[3];"toggleVisibility"===t&&await canvas.tokens.controlled[0].toggleVisibility(),"toggleCombat"===t&&await canvas.tokens.controlled[0].toggleCombat(),Hooks.callAll("forceUpdateTokenActionHud")}}class PreRollHandler extends RollHandler{prehandleActionEvent(e,t){return!1}}class CompendiumMacroPreHandler extends PreRollHandler{prehandleActionEvent(e,t){const n=game.tokenActionHud.actionHandler.delimiter,i=t.split(n);if(i.length<2)return!1;let o=null,a=null,s=null;if(2===i.length&&(o=i[0],s=i[1]),3===i.length&&(o=i[0],a=i[1],s=i[2]),!["compendiumEntry","compendiumMacro","compendiumPlaylist","macro"].includes(o))return!1;switch(o){case"compendiumEntry":this.handleCompendium(a,s);break;case"compendiumMacro":this.handleMacroCompendium(a,s);break;case"compendiumPlaylist":this.handlePlaylistCompendium(a,s);break;case"macro":this.handleMacro(s);break;default:return!1}return!0}handleCompendium(e,t){game.packs.get(e).getDocument(t).then((e=>e.sheet.render(!0)))}handleMacroCompendium(e,t){game.packs.get(e).getDocument(t).then((e=>e.execute()))}async handlePlaylistCompendium(e,t){const n=game.packs.get(e),i=t.split(">"),o=i[0],a=i[1],s=(await n.getDocument(o)).sounds.find((e=>e._id===a));AudioHelper.play({src:s.path},{})}handleMacro(e){game.macros.find((t=>t.id===e)).execute()}}class ItemMacroPreRollHandler extends PreRollHandler{prehandleActionEvent(e,t){this.registerKeyPresses(e);const n=t.split("|");if(4!==n.length)return!1;const i=n[0],o=n[1],a=n[2],s=n[3];return"itemMacro"===i&&(this.isRenderItem()?(this.doRenderItem(o,a,s),!0):this._tryExecuteItemMacro(e,o,a,s))}_tryExecuteItemMacro(e,t,n,i){const o=super.getActor(t,n),a=super.getItem(o,i);try{a.executeMacro()}catch(e){return Logger.error("ItemMacro error: ",e),!1}return!0}}class SystemManager{i18n=e=>game.i18n.localize(e);namespace="token-action-hud-core";doGetCategoryManager(){}doGetActionHandler(){}doGetRollHandler(e){}getAvailableRollHandlers(){}doRegisterSettings(e){}async doRegisterDefaultFlags(){}async registerDefaultFlags(){await game.user.unsetFlag(this.namespace,"default"),await this.doRegisterDefaultFlags()}async getActionHandler(e){const t=this.doGetActionHandler(this.categoryManager);return this.addActionExtenders(t),t}async getCompendiumActionHandler(e){return new CompendiumActionHandler(this.categoryManager)}addActionExtenders(e){SystemManager.isModuleActive("itemacro")&&e.addFurtherActionHandler(new ItemMacroActionListExtender)}categoryManager;async getCategoryManager(e){const t=this.doGetCategoryManager(e);return await t.init(),t}getRollHandler(){let e=getSetting("rollHandler");"core"===e||SystemManager.isModuleActive(e)||(Logger.error(e,this.i18n("tokenActionHud.handlerNotFound")),e="core",setSetting("rollHandler",e));const t=this.doGetRollHandler(e);return this.addPreHandlers(t),t}addPreHandlers(e){e.addPreRollHandler(new CompendiumMacroPreHandler),SystemManager.isModuleActive("itemacro")&&e.addPreRollHandler(new ItemMacroPreRollHandler)}registerSettings(){const e=this.getAvailableRollHandlers();registerSettings(this.namespace,this,e)}static addHandler(e,t){if(SystemManager.isModuleActive(t)){const n=SystemManager.getModuleTitle(t);mergeObject(e,{[t]:n})}}static isModuleActive(e){const t=game.modules.get(e);return t&&t.active}static getModuleTitle(e){return game.modules.get(e)?.title??""}}class TagDialog extends Dialog{i18n=e=>game.i18n.localize(e);tagify=null;dragSort=null;constructor(e,t){super(t),this.data=e,this.categoryId=null,this.subcategoryId=null}static showDialog(e,t,n,i,o,a){this.nestId=e,TagDialog._prepareHook(t,n);const s=Handlebars.compile("{{> modules/token-action-hud-core/templates/tagdialog.hbs}}")(o);new TagDialog({title:i,content:s,buttons:{accept:{icon:'<i class="fas fa-check"></i>',label:game.i18n.localize("tokenActionHud.accept"),callback:async e=>{const t=TagDialog.tagify.value.map((e=>(e.id=e.id??e.value.slugify({replacement:"-",strict:!0}),{id:e.id,name:e.value,type:e.type,level:e.level})));await a(t,e)}},cancel:{icon:'<i class="fas fa-times"></i>',label:game.i18n.localize("tokenActionHud.cancel")}},default:"accept"}).render(!0)}static _prepareHook(e,t){Hooks.once("renderTagDialog",((n,i,o)=>{i.css("height","auto");const a=i.find('select[id="token-action-hud-index"]');a.length>0&&(a.css("background","#fff"),a.css("color","#000"));const s=i.find('input[class="token-action-hud-taginput"]');if(s.length>0){const r={delimiters:";",maxTags:"Infinity",dropdown:{maxItems:50,classname:"tags-look",enabled:0,closeOnSelect:!1}};function onDragEnd(e){TagDialog.tagify.updateValueByDOMTags()}e&&(r.whitelist=e),TagDialog.tagify=new Tagify(s[0],r),TagDialog.dragSort=new DragSort(TagDialog.tagify.DOM.scope,{selector:"."+TagDialog.tagify.settings.classNames.tag,callbacks:{dragEnd:onDragEnd}});const c=$(document).find(".tagify");c.css("background","#fff"),c.css("color","#000"),t&&TagDialog.tagify.addTags(t);i.find('button[class="tags--removeAllBtn"]').on("click",TagDialog.tagify.removeAllTags.bind(TagDialog.tagify))}}))}_onKeyDown(e){if("Escape"===e.key&&!e.target.className.includes("tagify"))return e.preventDefault(),e.stopPropagation(),this.close();if("Enter"===e.key&&this.data.default&&!e.target.className.includes("tagify")){e.preventDefault(),e.stopPropagation();const t=this.data.buttons[this.data.default];return this.submit(t)}}}class TagDialogHelper{static showCategoryDialog(e){TagDialogHelper._showCategoryDialog(e)}static _showCategoryDialog(e){const t=e.getSelectedCategoriesAsTagifyEntries(),n=game.i18n.localize("tokenActionHud.categoryTagTitle"),i={topLabel:game.i18n.localize("tokenActionHud.categoryTagExplanation"),placeholder:game.i18n.localize("tokenActionHud.filterPlaceholder"),clearButtonText:game.i18n.localize("tokenActionHud.clearButton"),indexExplanationLabel:game.i18n.localize("tokenActionHud.pushLabelExplanation")};TagDialog.showDialog(null,null,t,n,i,(async t=>{await TagDialogHelper.saveCategories(e,t)}))}static showSubcategoryDialog(e,t){TagDialogHelper._showSubcategoryDialog(e,t)}static async _showSubcategoryDialog(e,t){const n=t.nestId,i=t.name,o=await e.getSubcategoriesAsTagifyEntries(),a=await e.getSelectedSubcategoriesAsTagifyEntries(t),s=game.i18n.localize("tokenActionHud.subcategoryTagTitle")+` (${i})`,r={topLabel:game.i18n.localize("tokenActionHud.subcategoryTagExplanation"),placeholder:game.i18n.localize("tokenActionHud.filterPlaceholder"),clearButtonText:game.i18n.localize("tokenActionHud.clearButton"),advancedCategoryOptions:game.user.getFlag("token-action-hud-core",`categories.${n}.advancedCategoryOptions`)};TagDialog.showDialog(n,o,a,s,r,(async(n,i)=>{n=n.map((e=>(e.id=e.id??e.name.slugify({replacement:"-",strict:!0}),e.type=e.type??"custom",{id:e.id,name:e.name,type:e.type})));const o={customWidth:parseInt(i.find('input[name="custom-width"]').val()),compactView:i.find('input[name="compact-view"]').prop("checked"),characterCount:parseInt(i.find('input[name="character-count"]').val())};await TagDialogHelper.saveSubcategories(e,n,o,t)}))}static async showActionDialog(e,t,n){await TagDialogHelper._showActionDialog(e,t,n)}static async _showActionDialog(e,t,n){const i=n?.nestId,o=n?.name,a=await t.getActionsAsTagifyEntries(n),s=await e.getSubcategoriesAsTagifyEntries(),r=[];r.push(...a,...s);const c=await t.getSelectedActionsAsTagifyEntries(n),l=await e.getSelectedSubcategoriesAsTagifyEntries(n),d=[];d.push(...c,...l);const g=`${game.i18n.localize("tokenActionHud.filterTitle")} (${o})`,u={topLabel:game.i18n.localize("tokenActionHud.filterTagExplanation"),placeholder:game.i18n.localize("tokenActionHud.filterPlaceholder"),clearButtonText:game.i18n.localize("tokenActionHud.clearButton"),indexExplanationLabel:game.i18n.localize("tokenActionHud.blockListLabel")};TagDialog.showDialog(i,r,d,g,u,(async i=>{await TagDialogHelper.saveActions(e,t,i,n)}))}static async saveCategories(e,t){await e.saveCategories(t),Hooks.callAll("forceUpdateTokenActionHud")}static async saveSubcategories(e,t,n,i){await e.saveSubcategories(t,n,i),Hooks.callAll("forceUpdateTokenActionHud")}static async saveActions(e,t,n,i){i.nestId;const o=n.filter((e=>"subcategory"===e.level));await e.saveSubcategories(o,"",i);const a=n.filter((e=>"action"===e.level));await t.saveActions(a,i),Hooks.callAll("forceUpdateTokenActionHud")}}class CategoryResizer{static resizeHoveredCategory(e){if(!e)return;const t=e.querySelectorAll(".tah-actions");if(0===t.length)return;const n=e.querySelector(".tah-subcategories"),i=e.id.replace("tah-category-",""),o=game.user.getFlag("token-action-hud-core",`categories.${i}.advancedCategoryOptions.customWidth`);if(o)return n.style.width=`${o}px`;const a=document.querySelector("#sidebar"),s=document.querySelector("#hotbar"),r=canvas.screenDimensions[0],c=canvas.screenDimensions[1],l=window.getComputedStyle(n),d=parseInt(l.paddingLeft)||0+parseInt(l.paddingRight)||0,g=n.getBoundingClientRect(),u=g.top,h=g.left,m=a.offsetLeft,f=a.clientWidth,p=(m>0?r-(m+f):r)-20-h,y=s.offsetTop,b=(y>0?y:c)-20;let k=null,A=0,H=0,C=0;for(const e of t){const t=e.querySelectorAll(".tah-action");if(t.length>0){(t.length<k||null===k)&&(k=t.length),C+=t.length;let e=0;t.forEach((t=>{const n=t.getBoundingClientRect(),i=Math.ceil(n.width);e+=i,H+=i}));const n=5*t.length;H+=n,e+=n,e>A&&(A=e)}}A+=d,H+=d;const v=Math.ceil(H/C);let S=5;const w=Math.floor(p/v);k<w&&k>S&&k<10&&(S=k),w<S&&(S=w);let T=v*S;T>A&&(T=A),T<200&&(T=200);const L=c-u-(c-b),M=L<100?100:L,I={width:`${T}px`,maxHeight:`${Math.ceil(M)}px`};Object.assign(n.style,I)}}class TokenActionHud extends Application{i18n=e=>game.i18n.localize(e);hoveredCategoryId="";defaultHeight=200;defaultWidth=20;defaultLeftPos=150;defaultTopPos=80;defaultScale=1;isDebug=null;refreshTimeout=null;rendering=!1;tokens=null;constructor(e){super(),this.systemManager=e}async init(e){this.isDebug=getSetting("debug"),await this.systemManager.registerDefaultFlags(),this.categoryManager=await this.systemManager.getCategoryManager(e),this.actionHandler=await this.systemManager.getActionHandler(e),this.rollHandler=this.systemManager.getRollHandler()}updateSettings(){this.updateRollHandler();this.update({trigger:{type:"method",name:"TokenActionHud.updateSettings"}})}updateRollHandler(){this.rollHandler=this.systemManager.getRollHandler()}setTokens(e){this.tokens=e}static get defaultOptions(){return mergeObject(super.defaultOptions,{template:"/modules/token-action-hud-core/templates/template.hbs",id:"token-action-hud",classes:[],width:this.defaultWidth,height:this.defaultHeight,left:this.defaultLeftPos,top:this.defaultTopPos,scale:this.defaultScale,background:"none",popOut:!1,minimizable:!1,resizable:!1,title:"token-action-hud",dragDrop:[],tabs:[],scrollY:[]})}getScale(){const e=parseFloat(getSetting("scale"));return e<.5?.5:e>2?2:e}getData(e={}){const t=super.getData();t.actions=this.actionList,t.id="token-action-hud",t.scale=this.getScale(),t.background=getSetting("background")??"#00000000",Logger.debug("Application data",{data:t});for(const n of t.actions.categories){const i=game.user.getFlag("token-action-hud-core",`categories.${n.id}.advancedCategoryOptions`);if(!i?.compactView)continue;const o=i.characterCount??2;function subcatRecursion(e){for(const t of e.subcategories){for(const e of t.actions)e.title=e.name,e.name.length<2||(e.name=0===o?"":e.name.split(" ").map((e=>e.slice(0,o))).join(" "));t.subcategories.length&&t.subcategories.forEach((e=>subcatRecursion(e)))}}n.subcategories&&subcatRecursion(n)}return t}activateListeners(e){const t="#tah-categories",n=e.find(".tah-category"),i=e.find(".tah-subcategory"),o="#tah-edit-categories",a="#tah-unlock",s="#tah-lock",r=".tah-title-button",c=e.find(r),l=e.find(".tah-subtitle"),d="#tah-collapse-hud",g="#tah-expand-hud",u="#tah-buttons";function closeCategory(e){if(game.tokenActionHud.rendering)return;this.classList.remove("hover");const t=this.id;game.tokenActionHud.clearHoveredCategory(t)}function openCategory(e){this.classList.add("hover");const t=this.id;game.tokenActionHud.setHoveredCategory(t),CategoryResizer.resizeHoveredCategory(this)}function toggleCategory(e){let t;if(this.parentElement.classList.contains("hover"))t=closeCategory.bind(this.parentElement),t(e);else{for(const e of n)e.classList.remove("hover");t=openCategory.bind(this.parentElement),t(e)}}function collapseHud(n=null){n&&(n.preventDefault(),n=n||window.event);const i=n?.target||e.find(d);$(i).addClass("tah-hidden"),e.find(g).removeClass("tah-hidden"),e.find(t).addClass("tah-hidden"),e.find(u).addClass("tah-hidden"),n&&game.user.setFlag("token-action-hud-core","isCollapsed",!0)}async function unlockHud(t=null){t&&(t.preventDefault(),t=t||window.event);const r=t?.target||e.find(a);$(r).addClass("tah-hidden"),e.find(s).removeClass("tah-hidden"),e.find(o).removeClass("tah-hidden"),n.removeClass("tah-hidden"),i.removeClass("tah-hidden"),c.removeClass("disable-edit"),l.removeClass("disable-edit"),t&&await game.user.setFlag("token-action-hud-core","isUnlocked",!0)}async function lockHud(t=null){t&&(t.preventDefault(),t=t||window.event);const r=t?.target||e.find(s);$(r).addClass("tah-hidden"),e.find(a).removeClass("tah-hidden"),e.find(o).addClass("tah-hidden");for(const e of n){e.getElementsByClassName("tah-action").length>0||$(e).addClass("tah-hidden")}for(const e of i){e.getElementsByClassName("tah-action").length>0||$(e).addClass("tah-hidden")}c.addClass("disable-edit"),l.addClass("disable-edit"),t&&await game.user.setFlag("token-action-hud-core","isUnlocked",!1)}game.user.getFlag("token-action-hud-core","isCollapsed")&&collapseHud(),game.user.getFlag("token-action-hud-core","isUnlocked")?unlockHud():lockHud(),e.find(r).on("click",(()=>this.bringToTop())),e.find(r).on("contextmenu",(e=>{game.user.getFlag("token-action-hud-core","isUnlocked")&&function openSubcategoryDialog(e){const t=e.target;if(0===t.value.length)return;const n=t.value,i=t.innerText??t.outerText,o=t?.dataset?.type;TagDialogHelper.showSubcategoryDialog(game.tokenActionHud.categoryManager,{nestId:n,name:i,type:o})}(e)})),e.find(".tah-subtitle").on("click contextmenu",(e=>{game.user.getFlag("token-action-hud-core","isUnlocked")&&function openActionDialog(e){const t=e.target;if(0===t.id.length)return;const n=t.id,i=t.innerText??t.outerText,o=t?.dataset?.type;TagDialogHelper.showActionDialog(game.tokenActionHud.categoryManager,game.tokenActionHud.actionHandler,{nestId:n,name:i,type:o})}(e)})),e.find(".tah-action").on("mousedown contextmenu",(e=>{e.preventDefault(),function handleAction(e){let t=e.target;"BUTTON"!==t.tagName&&(t=e.currentTarget.children[0]);const n=t.value;try{game.tokenActionHud.rollHandler.handleActionEvent(e,n),t.blur()}catch(t){Logger.error(e)}}(e)})),e.find(o).on("click",(e=>{e.preventDefault(),e=e||window.event,TagDialogHelper._showCategoryDialog(this.categoryManager)})),getSetting("clickOpenCategory")?c.on("click",toggleCategory):(c.get().forEach((e=>{e.addEventListener("touchstart",toggleCategory,{passive:!0})})),e.find(".tah-category").hover(openCategory,closeCategory)),c.on("mousedown",(e=>this.dragEvent(e))),c.get().forEach((e=>{e.addEventListener("touchstart",(e=>this.dragEvent(e)),{passive:!0})})),e.find(d).on("click",(e=>collapseHud(e))),e.find(g).on("click",(n=>function expandHud(n){n.preventDefault(),n=n||window.event,$(n.target).addClass("tah-hidden"),e.find(d).removeClass("tah-hidden"),e.find(t).removeClass("tah-hidden"),e.find(u).removeClass("tah-hidden"),game.user.setFlag("token-action-hud-core","isCollapsed",!1)}(n))),e.find(g).on("mousedown",(e=>this.dragEvent(e))),e.find(g).get(0).addEventListener("touchstart",(e=>this.dragEvent(e)),{passive:!0}),e.find(a).on("click",(e=>unlockHud(e))),e.find(s).on("click",(e=>lockHud(e))),$(document).find(".tah-filterholder").parents(".tah-subcategory").css("cursor","pointer")}dragEvent(e){if(!getSetting("drag"))return;const t=e.target.parentElement.closest("div#token-action-hud");document.onmousemove=mouseMoveEvent,document.onmouseup=mouseUpEvent,t.ontouchmove=mouseMoveEvent,t.ontouchend=mouseUpEvent;const n=e.clientX??e.changedTouches[0].clientX,i=e.clientY??e.changedTouches[0].clientY;let o=0,a=0,s=n,r=i;const c=t.offsetTop,l=t.offsetLeft;let d=c,g=l;function mouseMoveEvent(e){const n=(e=e||window.event).clientX??e.changedTouches[0].clientX,i=e.clientY??e.changedTouches[0].clientY;o=s-n,a=r-i,s=n,r=i,o===s&&a===r||(d-=a,g-=o,t.style.top=d+"px",t.style.left=g+"px",t.style.position="fixed")}function mouseUpEvent(){document.onmousemove=null,document.onmouseup=null,t.ontouchmove=null,t.ontouchend=null,d===c&&g===l||(game.user.update({flags:{"token-action-hud-core":{position:{top:d,left:g}}}}),Logger.debug(`Set position to x: ${d}px, y: ${g}px`))}}applySettings(){"up"===getSetting("direction")&&($(document).find(".tah-subcategories").removeClass("expand-down"),$(document).find(".tah-subcategories").addClass("expand-up"),$(document).find("#tah-character-name").addClass("tah-hidden"))}setPosition(){if(!this.actionList)return;const e=$(document).find("#tah-character-name");e.length>0&&e.css("top",-e[0].getBoundingClientRect().height),canvas?.tokens?.placeables.find((e=>e.id===this.actionList?.tokenId)),this.setPositionFromFlag(),this.restoreHoveredCategoryState(),this.rendering=!1}setPositionFromFlag(){if(!game.user.flags["token-action-hud-core"].position)return;const e=game.user.flags["token-action-hud-core"].position,t=this.defaultLeftPos,n=this.defaultTopPos;return new Promise((i=>{!function check(){const o=document.getElementById("token-action-hud");o?(o.style.bottom=null,o.style.top=e.top<5||e.top>window.innerHeight+5?n+"px":e.top+"px",o.style.left=e.left<5||e.left>window.innerWidth+5?t+"px":e.left+"px",o.style.position="fixed",i()):setTimeout(check,30)}()}))}setPositionFromToken(e){return new Promise((t=>{!function check(e){const n=$("#token-action-hud");n?(n.css("bottom",null),n.css("left",e.worldTransform.tx+(e.width*canvas.dimensions.size+55)*canvas.scene._viewPosition.scale+"px"),n.css("top",e.worldTransform.ty+0+"px"),n.css("position","fixed"),t()):setTimeout(check,30)}(e)}))}resetPosition(){Logger.debug("Resetting position..."),game.user.update({flags:{"token-action-hud-core":{position:{top:this.defaultTopPos,left:this.defaultLeftPos}}}}),Logger.debug(`Position reset to x: ${this.defaultTopPos}px, y: ${this.defaultLeftPos}px`)}setHoveredCategory(e){this.hoveredCategoryId=e}clearHoveredCategory(e){this.hoveredCategoryId===e&&(this.hoveredCategoryId="")}restoreHoveredCategoryState(){if(""===this.hoveredCategoryId)return;const e=`#${this.hoveredCategoryId}`,t=$(e);if(t[0])if(getSetting("clickOpenCategory")){t.find(".tah-title-button")[0].click()}else t.mouseenter()}async reset(){await this.resetUserFlags(),this.resetPosition()}async resetActorFlags(){await this.categoryManager.resetActorFlags();this.update({trigger:{type:"method",name:"TokenActionHud.resetActorFlags"}})}async resetUserFlags(){await this.categoryManager.resetUserFlags(),this.actionHandler.resetActionHandler();this.update({trigger:{type:"method",name:"TokenActionHud.resetUserFlags"}})}update(e=null){this._updateHud(e)}async _updateHud(e){Logger.debug("Updating hud...",e);const t=this.tokens?.controlled,n=this._getCharacter(t),i=t.length>1&&!n;(n||i)&&this.isHudEnabled()?(this.actionList=await this.actionHandler.buildActionList(n),this.rendering=!0,this.render(!0),Logger.debug("Hud updated")):this.close()}isValidTokenChange(e,t=null){return!t?.actorData?.flags&&(getSetting("alwaysShowHud")?this.isRelevantToken(e)||e.actorId===game.user.character?.id:this.isRelevantToken(e))}isRelevantToken(e){const t=this.tokens?.controlled;return t?.some((t=>t.id===e.id))||0===t?.length&&canvas?.tokens?.placeables?.some((e=>e.id===this.actionList?.tokenId))}isValidActorOrItemUpdate(e,t){return t?.flags?(Logger.debug("Flags set, do not update hud",{actor:e,data:t}),!1):e?e?this.actionList&&e.id===this.actionList.actorId?(Logger.debug("Same actor, update hud",{actor:e,data:t}),!0):(Logger.debug("Different actor, do not update hud",{actor:e,data:t}),!1):(Logger.debug("No actor, update hud",{data:t}),!0):void 0}isHudEnabled(){const e=game.user.role,t=game.user.isGM,n=getSetting("allow"),i=checkAllow(e),o=getSetting("enable");return Logger.debug("isHudEnabled()",{isGM:t,userRole:e,allowRole:n,isAllowed:i,isEnabled:o}),!!o&&(i||t)}isLinkedCompendium(e){return Logger.debug("Compendium hook triggered, checking if compendium is linked..."),this.categoryManager.isLinkedCompendium(e)}_getCharacter(e=[]){if(e.length>1)return null;let t;if(1===e.length){const n=e[0],i=n.actor;if(!this._isValidCharacter(n))return null;if(t={token:n,actor:i},t.id=n?.id??i?.id,t.name=n?.name??i?.name,t.id)return t}if(0===e.length&&game.user.character){if(!getSetting("alwaysShowHud"))return null;const e=game.user.character,n=canvas?.tokens?.placeables.find((t=>t.actor?.id===e?.id));if(t={token:n??null,actor:e},t.id=n?.id??e.id,t.name=n?.name??e.name,t.id)return t}return null}_isValidCharacter(e=""){const t=e.actor,n=game.user;return game.user.isGM||t?.testUserPermission(n,"OWNER")}}const t="token-action-hud-core";class CategoryManager{i18n=e=>game.i18n.localize(e);categories=[];user=null;constructor(e){this.user=e}async resetActorFlags(){Logger.debug("Resetting actor flags...");const e=game.actors.filter((e=>e.getFlag(t,"categories")));e&&e.forEach((e=>{Logger.debug(`Resetting flags for actor [${e.id}]`,{actor:e}),e.unsetFlag(t,"categories")})),Logger.debug("Actor flags reset")}async resetUserFlags(){Logger.debug("Resetting user flags..."),await game.user.unsetFlag(t,"categories"),await this._registerDefaultCategories(),Logger.debug("User flags reset")}async init(){const e=this.user.getFlag(t,"categories");if(!e)return this._registerDefaultCategories();Logger.debug("Retrieved saved categories",{savedCategories:e})}async _registerDefaultCategories(){const e=this.user.getFlag(t,"default.categories");e&&(await game.user.setFlag(t,"categories",e),Logger.debug("Registered default categories",{defaultCategories:e}))}async saveCategories(e){if(!e)return;const n=game.user.getFlag(t,"categories");n&&await this.deleteCategoriesFlag();const i={};for(const t of e){const e=t.id,o=Object.values(n).find((t=>t.id===e))?.subcategories??null;i[e]={id:t.id,name:t.name,subcategories:o}}const o=i;o&&await this.updateCategoriesFlag(o)}async saveSubcategories(e,n=null,i){if(!e)return;const o=game.user.getFlag(t,"categories"),a=await getSubcategoryByNestId(Object.values(o),i);if(!a)return;const s=i.nestId,r={};for(const t of e){r[`${s}_${t.id}`]=t}n&&(a.advancedCategoryOptions=n),a.subcategories=r;const c=o;c&&await this.updateCategoriesFlag(c)}async updateCategoriesFlag(e){await game.user.unsetFlag(t,"categories"),await game.user.setFlag(t,"categories",e)}async deleteCategoriesFlag(){await game.user.update({flags:{[t]:{"-=categories":null}}})}async deleteCategoryFlag(e){const n=e;await game.user.setFlag(t,"categories",{[`-=${n}`]:null})}async deleteSubcategoryFlag(e,n){const i=e,o=`${e}_${n}`;i&&await game.user.setFlag([t],`categories.${i}.subcategories`,{[`-=${o}`]:null})}getSelectedCategoriesAsTagifyEntries(){const e=this.user.getFlag(t,"categories");if(e)return Object.values(e).map((e=>this.toTagifyEntry(e)))}async getSelectedSubcategoriesAsTagifyEntries(e){const n=this.user.getFlag(t,"categories");if(!n)return[];const i=await getSubcategoryByNestId(Object.values(n),e);if(!i)return[];if(!i.subcategories)return[];const o=Object.values(i.subcategories).map((e=>this.toTagifyEntry(e)));return o||[]}getSubcategoriesAsTagifyEntries(){const e=this.getSystemSubcategoriesAsTagifyEntries(),t=this.getCompendiumSubcategoriesAsTagifyEntries(),n=[];return n.push(...e,...t),n}getSystemSubcategoriesAsTagifyEntries(){return this.user.getFlag(t,"default.subcategories").map((e=>this.toTagifyEntry(e)))}getCompendiumSubcategoriesAsTagifyEntries(){return game.packs.filter((e=>["JournalEntry","Macro","RollTable","Playlist"].includes(e.documentName))).filter((e=>game.user.isGM||!e.private)).map((e=>({id:e.metadata.id.replace(".","-"),value:e.metadata.label,type:"compendium",level:"subcategory"})))}isLinkedCompendium(e){return this.categories.some((t=>t.subcategories?.some((t=>t.compendiumId===e))))}toTagifyEntry(e){return{id:e.id,value:e.name,type:e.type,level:"subcategory"}}}let n;Hooks.on("ready",(async()=>{const e=game.system.id,t=`token-action-hud-${e}`,i=game.modules.get("token-action-hud-core").version,o=`../../${t}/enums/core-version.js`,a=await import(o).then((e=>e.coreModuleVersion));if(i!==a)return void ui.notifications.error(`The installed Token Action Hud system module requires Token Action Hud core module version ${a}.`);const s=`../../${t}/scripts/${t}.min.js`,r=(await import(s)).SystemManager;if(!r)return void ui.notifications.error("Token Action Hud system module not found.");const c=`token-action-hud-${e}`;game.modules.get(c)?.active?(n=new r("token-action-hud-core"),n.registerSettings(),switchCSS(getSetting("style")),registerHandlebars(),loadTemplates(["modules/token-action-hud-core/templates/category.hbs","modules/token-action-hud-core/templates/subcategory.hbs","modules/token-action-hud-core/templates/action.hbs","modules/token-action-hud-core/templates/tagdialog.hbs"]),Hooks.callAll("tokenActionHudInitialized")):ui.notifications.error("Token Action Hud system module is not active.")})),Hooks.on("canvasReady",(async()=>{Hooks.on("tokenActionHudInitialized",(async()=>{if(game.user.isGM&&!game.modules.get("lib-themer")?.active&&!game.modules.get("color-picker")?.active&&!game.modules.get("colorsettings")?.active){!1===getSetting("startup")&&(ui.notifications.notify("Token Action Hud: To set colors within this module's settings, install and enable one of the following 'Color Picker', 'Color Settings' or 'libThemer' modules."),setSetting("startup",!0))}const e=game.user;game.tokenActionHud||(game.tokenActionHud=new TokenActionHud(n),await game.tokenActionHud.init(e)),game.tokenActionHud.setTokens(canvas.tokens),Hooks.on("controlToken",((e,t)=>{const n={trigger:{type:"hook",name:"controlToken",data:[e,t]}};game.tokenActionHud.update(n)})),Hooks.on("updateToken",((e,t,n)=>{if(!Object.hasOwn(n,"y")&&!Object.hasOwn("diff","x")&&game.tokenActionHud.isValidTokenChange(e,t)){const i={trigger:{type:"hook",name:"updateToken",data:[e,t,n]}};game.tokenActionHud.update(i)}})),Hooks.on("deleteToken",((e,t,n,i)=>{if(game.tokenActionHud.isValidTokenChange(t)){const o={trigger:{type:"hook",name:"deleteToken",data:[e,t,n,i]}};game.tokenActionHud.update(o)}})),Hooks.on("updateActor",((e,t)=>{if(game.tokenActionHud.isValidActorOrItemUpdate(e,t)){const n={trigger:{type:"hook",name:"updateActor",data:[e,t]}};game.tokenActionHud.update(n)}})),Hooks.on("deleteActor",((e,t)=>{if(game.tokenActionHud.isValidActorOrItemUpdate(e,t)){const n={trigger:{type:"hook",name:"deleteActor",data:[e,t]}};game.tokenActionHud.update(n)}})),Hooks.on("deleteItem",(e=>{const t=e.actor;if(game.tokenActionHud.isValidActorOrItemUpdate(t)){const t={trigger:{type:"hook",name:"deleteItem",data:[e]}};game.tokenActionHud.update(t)}})),Hooks.on("createItem",(e=>{const t=e.actor;if(game.tokenActionHud.isValidActorOrItemUpdate(t)){const t={trigger:{type:"hook",name:"createItem",data:[e]}};game.tokenActionHud.update(t)}})),Hooks.on("updateItem",(e=>{const t=e.actor;if(game.tokenActionHud.isValidActorOrItemUpdate(t)){const t={trigger:{type:"hook",name:"updateItem",data:[e]}};game.tokenActionHud.update(t)}})),Hooks.on("renderTokenActionHud",(()=>{game.tokenActionHud.applySettings()})),Hooks.on("renderCompendium",((e,t)=>{const n=e?.metadata;if(game.tokenActionHud.isLinkedCompendium(`${n?.package}.${n?.name}`)){const n={trigger:{type:"hook",name:"renderCompendium",data:[e,t]}};game.tokenActionHud.update(n)}})),Hooks.on("deleteCompendium",((e,t)=>{const n=e?.metadata;if(game.tokenActionHud.isLinkedCompendium(`${n?.package}.${n?.name}`)){const n={trigger:{type:"hook",name:"deleteCompendium",data:[e,t]}};game.tokenActionHud.update(n)}})),Hooks.on("createCombat",(e=>{const t={trigger:{type:"hook",name:"createCombat",data:[e]}};game.tokenActionHud.update(t)})),Hooks.on("deleteCombat",(e=>{const t={trigger:{type:"hook",name:"deleteCombat",data:[e]}};game.tokenActionHud.update(t)})),Hooks.on("updateCombat",(e=>{const t={trigger:{type:"hook",name:"updateCombat",data:[e]}};game.tokenActionHud.update(t)})),Hooks.on("updateCombatant",((e,t)=>{const n={trigger:{type:"hook",name:"updateCombatant",data:[e,t]}};game.tokenActionHud.update(n)})),Hooks.on("forceUpdateTokenActionHud",(()=>{game.tokenActionHud.update({trigger:{type:"hook",name:"forceUpdateTokenActionHud"}})})),Hooks.on("createActiveEffect",(()=>{game.tokenActionHud.update({trigger:{type:"hook",name:"createActiveEffect"}})})),Hooks.on("deleteActiveEffect",(()=>{game.tokenActionHud.update({trigger:{type:"hook",name:"deleteActiveEffect"}})}));game.tokenActionHud.update({trigger:{type:"hook",name:"canvasReady"}})}))}));class Action{constructor(){this.id="",this.name="",this.encodedValue="",this.info1="",this.info2="",this.info3="",this.cssClass="",this.icon1="",this.icon2="",this.icon3="",this.img="",this.selected=!0}}export{Action,ActionCategory,ActionHandler,ActionList,ActionListExtender,ActionSubcategory,CategoryManager,CategoryResizer,CompendiumActionHandler,CompendiumMacroPreHandler,GenericActionHandler,ItemMacroActionListExtender,ItemMacroPreRollHandler,Logger,MacroActionHandler,PreRollHandler,RollHandler,SystemManager,TagDialog,TagDialogHelper,TokenActionHud,checkAllow,getSetting,getSubcategories,getSubcategoryByNestId,initColorSettings,registerHandlebars,registerSettings,setSetting,switchCSS};
